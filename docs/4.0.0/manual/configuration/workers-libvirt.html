<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Libvirt &mdash; Buildbot 4.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d10597a4" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/buildbot_rtd.css?v=915d5e18" />

  
    <link rel="shortcut icon" href="../../_static/icon.png"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=3304f9e4"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="OpenStack" href="workers-openstack.html" />
    <link rel="prev" title="Amazon Web Services Elastic Compute Cloud (“AWS EC2”)" href="workers-ec2.html" /> 
<!-- GA-TRACKING-START -->
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try{
var pageTracker = _gat._getTracker("UA-12313843-4");
pageTracker._setDomainName("none");
pageTracker._setAllowLinker(true);
pageTracker._trackPageview();
} catch(err) {}
</script>
<!-- GA-TRACKING-END -->
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Buildbot
              <img src="../../_static/full_logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                4.0.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../tutorial/index.html">1. Buildbot Tutorial</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">2. Buildbot Manual</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../introduction.html">2.1. Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation/index.html">2.2. Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts.html">2.3. Concepts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../secretsmanagement.html">2.4. Secret Management</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">2.5. Configuration</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="intro.html">2.5.1. Configuring Buildbot</a></li>
<li class="toctree-l3"><a class="reference internal" href="global.html">2.5.2. Global Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="changesources.html">2.5.3. Change Sources and Changes</a></li>
<li class="toctree-l3"><a class="reference internal" href="changesources.html#changes">2.5.4. Changes</a></li>
<li class="toctree-l3"><a class="reference internal" href="schedulers.html">2.5.5. Schedulers</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="workers.html">2.5.6. Workers</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="workers.html#defining-workers">2.5.6.1. Defining Workers</a></li>
<li class="toctree-l4"><a class="reference internal" href="workers.html#worker-options">2.5.6.2. Worker Options</a></li>
<li class="toctree-l4"><a class="reference internal" href="workers.html#local-workers">2.5.6.3. Local Workers</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="workers.html#latent-workers">2.5.6.4. Latent Workers</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="builders.html">2.5.7. Builder Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="projects.html">2.5.8. Projects</a></li>
<li class="toctree-l3"><a class="reference internal" href="buildfactories.html">2.5.9. Build Factories</a></li>
<li class="toctree-l3"><a class="reference internal" href="buildsets.html">2.5.10. Build Sets</a></li>
<li class="toctree-l3"><a class="reference internal" href="properties.html">2.5.11. Properties</a></li>
<li class="toctree-l3"><a class="reference internal" href="steps/index.html">2.5.12. Build Steps</a></li>
<li class="toctree-l3"><a class="reference internal" href="interlocks.html">2.5.13. Interlocks</a></li>
<li class="toctree-l3"><a class="reference internal" href="report_generators/index.html">2.5.14. Report Generators</a></li>
<li class="toctree-l3"><a class="reference internal" href="reporters/index.html">2.5.15. Reporters</a></li>
<li class="toctree-l3"><a class="reference internal" href="www.html">2.5.16. Web Server</a></li>
<li class="toctree-l3"><a class="reference internal" href="wwwhooks.html">2.5.17. Change Hooks</a></li>
<li class="toctree-l3"><a class="reference internal" href="services/index.html">2.5.18. Custom Services</a></li>
<li class="toctree-l3"><a class="reference internal" href="dbconfig.html">2.5.19. DbConfig</a></li>
<li class="toctree-l3"><a class="reference internal" href="configurators.html">2.5.20. Configurators</a></li>
<li class="toctree-l3"><a class="reference internal" href="manhole.html">2.5.21. Manhole</a></li>
<li class="toctree-l3"><a class="reference internal" href="multimaster.html">2.5.22. Multimaster</a></li>
<li class="toctree-l3"><a class="reference internal" href="multicodebase.html">2.5.23. Multiple-Codebase Builds</a></li>
<li class="toctree-l3"><a class="reference internal" href="misc/index.html">2.5.24. Miscellaneous Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="tests/index.html">2.5.25. Testing Utilities</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../customization.html">2.6. Customization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cmdline.html">2.7. Command-line Tool</a></li>
<li class="toctree-l2"><a class="reference internal" href="../resources.html">2.8. Resources</a></li>
<li class="toctree-l2"><a class="reference internal" href="../optimization.html">2.9. Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plugins.html">2.10. Plugin Infrastructure in Buildbot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../deploy.html">2.11. Deployment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../upgrading/index.html">2.12. Upgrading</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/index.html">3. Buildbot Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../relnotes/index.html">4. Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../relnotes/index.html#older-release-notes">5. Older Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../indices.html">6. API Indices</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Buildbot</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html"><span class="section-number">2. </span>Buildbot Manual</a></li>
          <li class="breadcrumb-item"><a href="index.html"><span class="section-number">2.5. </span>Configuration</a></li>
          <li class="breadcrumb-item"><a href="workers.html"><span class="section-number">2.5.6. </span>Workers</a></li>
      <li class="breadcrumb-item active">Libvirt</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/manual/configuration/workers-libvirt.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="libvirt">
<span id="worker-LibVirtWorker"></span><span id="index-0"></span><h1>Libvirt<a class="headerlink" href="#libvirt" title="Link to this heading"></a></h1>
<dl class="py class">
<dt class="sig sig-object py" id="buildbot.worker.libvirt.LibVirtWorker">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">buildbot.worker.libvirt.</span></span><span class="sig-name descname"><span class="pre">LibVirtWorker</span></span><a class="headerlink" href="#buildbot.worker.libvirt.LibVirtWorker" title="Link to this definition"></a></dt>
<dd></dd></dl>

<p><a class="reference external" href="http://www.libvirt.org/">libvirt</a> is a virtualization API for interacting with the virtualization capabilities of recent versions of Linux and other OSes.
It is LGPL and comes with a stable C API, and Python bindings.</p>
<p>This means we now have an API which when tied to buildbot allows us to have workers that run under Xen, QEMU, KVM, LXC, OpenVZ, User Mode Linux, VirtualBox and VMWare.</p>
<p>The libvirt code in Buildbot was developed against libvirt 0.7.5 on Ubuntu Lucid.
It is used with KVM to test Python code on VMs, but obviously isn’t limited to that.
Each build is run on a new VM, images are temporary and thrown away after each build.</p>
<p>This document will guide you through setup of a libvirt latent worker:</p>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#setting-up-libvirt" id="id2">Setting up libvirt</a></p></li>
<li><p><a class="reference internal" href="#configuring-your-base-image" id="id3">Configuring your base image</a></p></li>
<li><p><a class="reference internal" href="#configuring-your-master" id="id4">Configuring your Master</a></p></li>
<li><p><a class="reference internal" href="#connection-to-master" id="id5">Connection to master</a></p></li>
<li><p><a class="reference internal" href="#configuring-master-to-use-libvirt-on-remote-server" id="id6">Configuring Master to use libvirt on remote server</a></p></li>
</ul>
</nav>
<section id="setting-up-libvirt">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Setting up libvirt</a><a class="headerlink" href="#setting-up-libvirt" title="Link to this heading"></a></h2>
<p>We won’t show you how to set up libvirt as it is quite different on each platform, but there are a few things you should keep in mind.</p>
<ul class="simple">
<li><p>If you are using the system libvirt (libvirt and buildbot master are on same server), your buildbot master user will need to be in the libvirtd group.</p></li>
<li><p>If libvirt and buildbot master are on different servers, the user connecting to libvirt over ssh will need to be in the libvirtd group. Also need to setup authorization via ssh-keys (without password prompt).</p></li>
<li><p>If you are using KVM, your buildbot master user will need to be in the KVM group.</p></li>
<li><p>You need to think carefully about your virtual network <em>first</em>.
Will NAT be enough?
What IP will my VMs need to connect to for connecting to the master?</p></li>
</ul>
</section>
<section id="configuring-your-base-image">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">Configuring your base image</a><a class="headerlink" href="#configuring-your-base-image" title="Link to this heading"></a></h2>
<p>You need to create a base image for your builds that has everything needed to build your software.
You need to configure the base image with a buildbot worker that is configured to connect to the master on boot.</p>
<p>Because this image may need updating a lot, we strongly suggest scripting its creation.</p>
<p>If you want to have multiple workers using the same base image it can be annoying to duplicate the image just to change the buildbot credentials.
One option is to use libvirt’s DHCP server to allocate an identity to the worker: DHCP sets a hostname, and the worker takes its identity from that.</p>
<p>Doing all this is really beyond the scope of the manual, but there is a <a class="reference external" href="https://github.com/buildbot/buildbot-contrib/tree/master/master/contrib/libvirt/vmbuilder">vmbuilder</a> script and a <a class="reference external" href="https://github.com/buildbot/buildbot-contrib/tree/master/master/contrib/libvirt/network.xml">network.xml</a> file to create such a DHCP server in <a class="reference external" href="https://github.com/buildbot/buildbot-contrib/tree/master/master/contrib/">master/contrib/</a> (<a class="reference internal" href="../deploy.html#contrib-scripts"><span class="std std-ref">Contrib Scripts</span></a>) that should get you started:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>ubuntu-vm-builder
sudo<span class="w"> </span>contrib/libvirt/vmbuilder
</pre></div>
</div>
<p>Should create an <code class="file docutils literal notranslate"><span class="pre">ubuntu/</span></code> folder with a suitable image in it.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>virsh net-define contrib/libvirt/network.xml
virsh net-start buildbot-network
</pre></div>
</div>
<p>Should set up a KVM compatible libvirt network for your buildbot VM’s to run on.</p>
</section>
<section id="configuring-your-master">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Configuring your Master</a><a class="headerlink" href="#configuring-your-master" title="Link to this heading"></a></h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>There is currently a buildbot bug that fails to use the <code class="docutils literal notranslate"><span class="pre">base_image</span></code> if provided.
This means that the worker always uses the <code class="docutils literal notranslate"><span class="pre">hd_image</span></code> and changes will persist between builds.
See the <a class="reference external" href="https://github.com/buildbot/buildbot/issues/7122">GitHub issue</a> for details.</p>
</div>
<p>If you want to add a simple on demand VM to your setup, you only need the following.
We set the username to <code class="docutils literal notranslate"><span class="pre">minion1</span></code>, the password to <code class="docutils literal notranslate"><span class="pre">sekrit</span></code>.
The base image is called <code class="docutils literal notranslate"><span class="pre">base_image</span></code> and a copy of it will be made for the duration of the VM’s life.
That copy will be thrown away every time a build is complete.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">buildbot.plugins</span> <span class="kn">import</span> <span class="n">worker</span><span class="p">,</span> <span class="n">util</span>
<span class="n">c</span><span class="p">[</span><span class="s1">&#39;workers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">LibVirtWorker</span><span class="p">(</span><span class="s1">&#39;minion1&#39;</span><span class="p">,</span> <span class="s1">&#39;sekrit&#39;</span><span class="p">,</span>
                         <span class="n">uri</span><span class="o">=</span><span class="s2">&quot;qemu:///session&quot;</span><span class="p">,</span>
                         <span class="n">hd_image</span><span class="o">=</span><span class="s1">&#39;/home/buildbot/images/minion1&#39;</span><span class="p">,</span>
                         <span class="n">base_image</span><span class="o">=</span><span class="s1">&#39;/home/buildbot/images/base_image&#39;</span><span class="p">)</span>
<span class="p">]</span>
</pre></div>
</div>
<p>You can use virt-manager to define <code class="docutils literal notranslate"><span class="pre">minion1</span></code> with the correct hardware.
If you don’t, buildbot won’t be able to find a VM to start.</p>
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">LibVirtWorker</span></code> accepts the following arguments:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">name</span></code></dt><dd><p>Both a buildbot username and the name of the virtual machine.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">password</span></code></dt><dd><p>A password for the buildbot to login to the master with.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">hd_image</span></code></dt><dd><p>The path to a libvirt disk image, normally in qcow2 format when using KVM.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">base_image</span></code></dt><dd><p>If given a base image, buildbot will clone it every time it starts a VM.
This means you always have a clean environment to do your build in.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">uri</span></code></dt><dd><p>The URI of the connection to libvirt.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">masterFQDN</span></code></dt><dd><p>(optional, defaults to <code class="docutils literal notranslate"><span class="pre">socket.getfqdn()</span></code>)
Address of the master the worker should connect to.
Use if you master machine does not have proper fqdn.
This value is passed to the libvirt image via domain metadata.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">xml</span></code></dt><dd><p>If a VM isn’t predefined in virt-manager, then you can instead provide XML like that used with <code class="docutils literal notranslate"><span class="pre">virsh</span> <span class="pre">define</span></code>.
The VM will be created automatically when needed, and destroyed when not needed any longer.</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">hd_image</span></code> and <code class="docutils literal notranslate"><span class="pre">base_image</span></code> must be on same machine with buildbot master.</p>
</div>
</section>
<section id="connection-to-master">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">Connection to master</a><a class="headerlink" href="#connection-to-master" title="Link to this heading"></a></h2>
<p>If <code class="docutils literal notranslate"><span class="pre">xml</span></code> configuration key is not provided, then Buildbot will set libvirt metadata for the domain.
It will contain the following XML element: <code class="docutils literal notranslate"><span class="pre">&lt;auth</span> <span class="pre">username=&quot;...&quot;</span> <span class="pre">password=&quot;...&quot;</span> <span class="pre">master=&quot;...&quot;/&gt;</span></code>.
Here <code class="docutils literal notranslate"><span class="pre">username</span></code>, <code class="docutils literal notranslate"><span class="pre">password</span></code> and <code class="docutils literal notranslate"><span class="pre">master</span></code> are the name of the worker, password to use for connection and the FQDN of the master.
The libvirt metadata will be placed in the XML namespace <code class="docutils literal notranslate"><span class="pre">buildbot=http://buildbot.net/</span></code>.</p>
</section>
<section id="configuring-master-to-use-libvirt-on-remote-server">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">Configuring Master to use libvirt on remote server</a><a class="headerlink" href="#configuring-master-to-use-libvirt-on-remote-server" title="Link to this heading"></a></h2>
<p>If you want to use libvirt on remote server configure remote libvirt server and buildbot server following way.</p>
<ol class="arabic simple">
<li><p>Define user to connect to remote machine using ssh. Configure connection of such user to remote libvirt server (see <a class="reference external" href="https://wiki.libvirt.org/page/SSHSetup">https://wiki.libvirt.org/page/SSHSetup</a>) without password prompt.</p></li>
<li><p>Add user to libvirtd group on remote libvirt server <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">usermod</span> <span class="pre">-G</span> <span class="pre">libvirtd</span> <span class="pre">-a</span> <span class="pre">&lt;user&gt;</span></code>.</p></li>
</ol>
<p>Configure remote libvirt server:</p>
<ol class="arabic simple">
<li><p>Create virtual machine for buildbot and configure it.</p></li>
<li><p>Change virtual machine image file to new name, which will be used as temporary image and deleted after virtual machine stops. Execute command <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">virsh</span> <span class="pre">edit</span> <span class="pre">&lt;VM</span> <span class="pre">name&gt;</span></code>. In xml file locate <code class="docutils literal notranslate"><span class="pre">devices/disk/source</span></code> and change file path to new name. The file must not be exists, it will create via hook script.</p></li>
<li><p>Add hook script to <code class="docutils literal notranslate"><span class="pre">/etc/libvirt/hooks/qemu</span></code> to recreate VM image each start:</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/python</span>

<span class="c1"># Script /etc/libvirt/hooks/qemu</span>
<span class="c1"># Don&#39;t forget to execute service libvirt-bin restart</span>
<span class="c1"># Also see https://www.libvirt.org/hooks.html</span>

<span class="c1"># This script make clean VM for each start using base image</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">images_path</span> <span class="o">=</span> <span class="s1">&#39;/var/lib/libvirt/images/&#39;</span>

<span class="c1"># build-vm - VM name in virsh list --all</span>
<span class="c1"># vm_base_image.qcow2 - base image file name, must exist in path /var/lib/libvirt/images/</span>
<span class="c1"># vm_temp_image.qcow2 - temporary image. Must not exist in path /var/lib/libvirt/images/, but</span>
<span class="c1"># defined in VM config file</span>
<span class="n">domains</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;build-vm&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;vm_base_image.qcow2&#39;</span><span class="p">,</span> <span class="s1">&#39;vm_temp_image.qcow2&#39;</span><span class="p">],</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">delete_image_clone</span><span class="p">(</span><span class="n">vir_domain</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">vir_domain</span> <span class="ow">in</span> <span class="n">domains</span><span class="p">:</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="n">domains</span><span class="p">[</span><span class="n">vir_domain</span><span class="p">]</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">images_path</span> <span class="o">+</span> <span class="n">domain</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">create_image_clone</span><span class="p">(</span><span class="n">vir_domain</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">vir_domain</span> <span class="ow">in</span> <span class="n">domains</span><span class="p">:</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="n">domains</span><span class="p">[</span><span class="n">vir_domain</span><span class="p">]</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;/usr/bin/qemu-img&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;-b&#39;</span><span class="p">,</span> <span class="n">images_path</span> <span class="o">+</span> <span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
               <span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="s1">&#39;qcow2&#39;</span><span class="p">,</span> <span class="s1">&#39;-F&#39;</span><span class="p">,</span> <span class="s1">&#39;qcow2&#39;</span><span class="p">,</span> <span class="n">images_path</span> <span class="o">+</span> <span class="n">domain</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">vir_domain</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">action</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;prepare&quot;</span><span class="p">]:</span>
        <span class="n">create_image_clone</span><span class="p">(</span><span class="n">vir_domain</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">action</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;release&quot;</span><span class="p">]:</span>
        <span class="n">delete_image_clone</span><span class="p">(</span><span class="n">vir_domain</span><span class="p">)</span>
</pre></div>
</div>
<p>Configure buildbot server:</p>
<ol class="arabic simple">
<li><p>On buildbot server in virtual environment install libvirt-python package: <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">libvirt-python</span></code></p></li>
<li><p>Create worker using remote ssh connection.</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">buildbot.plugins</span> <span class="kn">import</span> <span class="n">worker</span><span class="p">,</span> <span class="n">util</span>
<span class="n">c</span><span class="p">[</span><span class="s1">&#39;workers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">LibVirtWorker</span><span class="p">(</span>
        <span class="s1">&#39;minion1&#39;</span><span class="p">,</span> <span class="s1">&#39;sekrit&#39;</span><span class="p">,</span>
        <span class="n">util</span><span class="o">.</span><span class="n">Connection</span><span class="p">(</span><span class="s2">&quot;qemu+ssh://&lt;user&gt;@&lt;ip address or DNS name&gt;:&lt;port&gt;/session&quot;</span><span class="p">),</span>
        <span class="s1">&#39;/home/buildbot/images/minion1&#39;</span><span class="p">)</span>
<span class="p">]</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="workers-ec2.html" class="btn btn-neutral float-left" title="Amazon Web Services Elastic Compute Cloud (“AWS EC2”)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="workers-openstack.html" class="btn btn-neutral float-right" title="OpenStack" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Buildbot Team Members.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>