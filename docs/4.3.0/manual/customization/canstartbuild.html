

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2.6.4. canStartBuild Functions &mdash; Buildbot 4.3.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d10597a4" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/buildbot_rtd.css?v=915d5e18" />

  
    <link rel="shortcut icon" href="../../_static/icon.png"/>
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=a17b270f"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="2.6.5. Customizing SVNPoller" href="svnpoller.html" />
    <link rel="prev" title="2.6.3. Priorities" href="priorities.html" /> 
<!-- GA-TRACKING-START -->
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try{
var pageTracker = _gat._getTracker("UA-12313843-4");
pageTracker._setDomainName("none");
pageTracker._setAllowLinker(true);
pageTracker._trackPageview();
} catch(err) {}
</script>
<!-- GA-TRACKING-END -->
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Buildbot
              <img src="../../_static/full_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../tutorial/index.html">1. Buildbot Tutorial</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">2. Buildbot Manual</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../introduction.html">2.1. Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation/index.html">2.2. Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts.html">2.3. Concepts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../secretsmanagement.html">2.4. Secret Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration/index.html">2.5. Configuration</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">2.6. Customization</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="programmatic.html">2.6.1. Programmatic Configuration Generation</a></li>
<li class="toctree-l3"><a class="reference internal" href="collapse-requests.html">2.6.2. Collapse Request Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="priorities.html">2.6.3. Priorities</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">2.6.4. <code class="docutils literal notranslate"><span class="pre">canStartBuild</span></code> Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="svnpoller.html">2.6.5. Customizing SVNPoller</a></li>
<li class="toctree-l3"><a class="reference internal" href="changesources.html">2.6.6. Writing Change Sources</a></li>
<li class="toctree-l3"><a class="reference internal" href="latent-workers.html">2.6.7. Writing a New Latent Worker Implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="buildclasses.html">2.6.8. Custom Build Classes</a></li>
<li class="toctree-l3"><a class="reference internal" href="workdir.html">2.6.9. Factory Workdir Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="buildsteps.html">2.6.10. Writing New BuildSteps</a></li>
<li class="toctree-l3"><a class="reference internal" href="dashboards.html">2.6.11. Writing Dashboards with Flask or Bottle</a></li>
<li class="toctree-l3"><a class="reference internal" href="example.html">2.6.12. A Somewhat Whimsical Example (or “It’s now customized, how do I deploy it?”)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../cmdline.html">2.7. Command-line Tool</a></li>
<li class="toctree-l2"><a class="reference internal" href="../resources.html">2.8. Resources</a></li>
<li class="toctree-l2"><a class="reference internal" href="../optimization.html">2.9. Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plugins.html">2.10. Plugin Infrastructure in Buildbot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../deploy.html">2.11. Deployment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../upgrading/index.html">2.12. Upgrading</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/index.html">3. Buildbot Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../relnotes/index.html">4. Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../relnotes/index.html#older-release-notes">5. Older Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../indices.html">6. API Indices</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Buildbot</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html"><span class="section-number">2. </span>Buildbot Manual</a></li>
          <li class="breadcrumb-item"><a href="index.html"><span class="section-number">2.6. </span>Customization</a></li>
      <li class="breadcrumb-item active"><span class="section-number">2.6.4. </span><code class="docutils literal notranslate"><span class="pre">canStartBuild</span></code> Functions</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/manual/customization/canstartbuild.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="canstartbuild-functions">
<span id="id1"></span><h1><span class="section-number">2.6.4. </span><code class="docutils literal notranslate"><span class="pre">canStartBuild</span></code> Functions<a class="headerlink" href="#canstartbuild-functions" title="Link to this heading"></a></h1>
<p>Sometimes, you cannot know in advance what workers to assign to a <code class="xref py py-class docutils literal notranslate"><span class="pre">BuilderConfig</span></code>. For
example, you might need to check for the existence of a file on a worker before running a build on
it. It is possible to do that by setting the <code class="docutils literal notranslate"><span class="pre">canStartBuild</span></code> callback.</p>
<p>Here is an example that checks if there is a <code class="docutils literal notranslate"><span class="pre">vm</span></code> property set for the build request. If it is
set, it checks if a file named after it exists in the <code class="docutils literal notranslate"><span class="pre">/opt/vm</span></code> folder. If the file does not
exist on the given worker, refuse to run the build to force the master to select another worker.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@defer</span><span class="o">.</span><span class="n">inlineCallbacks</span>
<span class="k">def</span> <span class="nf">canStartBuild</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">wfb</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>

    <span class="n">vm</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vm&#39;</span><span class="p">,</span> <span class="n">builder</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vm&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">vm</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/opt/vm&#39;</span><span class="p">,</span> <span class="n">vm</span><span class="p">)}</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">RemoteCommand</span><span class="p">(</span><span class="s1">&#39;stat&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">stdioLogName</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">worker</span> <span class="o">=</span> <span class="n">wfb</span><span class="o">.</span><span class="n">worker</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">cmd</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">wfb</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">conn</span><span class="p">,</span> <span class="n">builder</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span>
</pre></div>
</div>
<p>Here is a more complete example that checks if a worker is fit to start a build. If the load
average is higher than the number of CPU cores or if there is less than 2GB of free memory, refuse
to run the build on that worker. Also, put that worker in quarantine to make sure no other builds
are scheduled on it for a while. Otherwise, let the build start on that worker.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FakeBuild</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">properties</span> <span class="o">=</span> <span class="n">Properties</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">FakeStep</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">build</span> <span class="o">=</span> <span class="n">FakeBuild</span><span class="p">()</span>

<span class="nd">@defer</span><span class="o">.</span><span class="n">inlineCallbacks</span>
<span class="k">def</span> <span class="nf">shell</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">worker</span><span class="p">,</span> <span class="n">builder</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;command&#39;</span><span class="p">:</span> <span class="n">command</span><span class="p">,</span>
        <span class="s1">&#39;logEnviron&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;workdir&#39;</span><span class="p">:</span> <span class="n">worker</span><span class="o">.</span><span class="n">worker_basedir</span><span class="p">,</span>
        <span class="s1">&#39;want_stdout&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;want_stderr&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">RemoteCommand</span><span class="p">(</span><span class="s1">&#39;shell&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">stdioLogName</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">cmd</span><span class="o">.</span><span class="n">worker</span> <span class="o">=</span> <span class="n">worker</span>
    <span class="k">yield</span> <span class="n">cmd</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">FakeStep</span><span class="p">(),</span> <span class="n">worker</span><span class="o">.</span><span class="n">conn</span><span class="p">,</span> <span class="n">builder</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cmd</span><span class="o">.</span><span class="n">rc</span>

<span class="nd">@defer</span><span class="o">.</span><span class="n">inlineCallbacks</span>
<span class="k">def</span> <span class="nf">canStartBuild</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">wfb</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="c1"># check that load is not too high</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">shell</span><span class="p">(</span>
        <span class="s1">&#39;test &quot;$(cut -d. -f1 /proc/loadavg)&quot; -le &quot;$(nproc)&quot;&#39;</span><span class="p">,</span>
        <span class="n">wfb</span><span class="o">.</span><span class="n">worker</span><span class="p">,</span> <span class="n">builder</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;loadavg is too high to take new builds&#39;</span><span class="p">,</span>
                <span class="n">system</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">wfb</span><span class="o">.</span><span class="n">worker</span><span class="p">))</span>
        <span class="n">wfb</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">putInQuarantine</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># check there is enough free memory</span>
    <span class="n">sed_expr</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;s/^MemAvailable:[[:space:]]+([0-9]+)[[:space:]]+kB$/\1/p&#39;</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">shell</span><span class="p">(</span>
        <span class="s1">&#39;test &quot;$(sed -nre </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1"> /proc/meminfo)&quot; -gt 2000000&#39;</span> <span class="o">%</span> <span class="n">sed_expr</span><span class="p">,</span>
        <span class="n">wfb</span><span class="o">.</span><span class="n">worker</span><span class="p">,</span> <span class="n">builder</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;not enough free memory to take new builds&#39;</span><span class="p">,</span>
                <span class="n">system</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">wfb</span><span class="o">.</span><span class="n">worker</span><span class="p">))</span>
        <span class="n">wfb</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">putInQuarantine</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># The build may now proceed.</span>
    <span class="c1">#</span>
    <span class="c1"># Prevent this worker from taking any other build while this one is</span>
    <span class="c1"># starting for 2 min. This leaves time for the build to start consuming</span>
    <span class="c1"># resources (disk, memory, cpu). When the quarantine is over, if the</span>
    <span class="c1"># same worker is subject to start another build, the above checks will</span>
    <span class="c1"># better reflect the actual state of the worker.</span>
    <span class="n">wfb</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">quarantine_timeout</span> <span class="o">=</span> <span class="mi">120</span>
    <span class="n">wfb</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">putInQuarantine</span><span class="p">()</span>

    <span class="c1"># This does not take the worker out of quarantine, it only resets the</span>
    <span class="c1"># timeout value to default.</span>
    <span class="n">wfb</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">resetQuarantine</span><span class="p">()</span>

    <span class="k">return</span> <span class="kc">True</span>
</pre></div>
</div>
<p>You can extend these examples using any remote command described in the <a class="reference internal" href="../../developer/master-worker.html"><span class="doc">Master-Worker API</span></a>.</p>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="priorities.html" class="btn btn-neutral float-left" title="2.6.3. Priorities" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="svnpoller.html" class="btn btn-neutral float-right" title="2.6.5. Customizing SVNPoller" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Buildbot Team Members.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>