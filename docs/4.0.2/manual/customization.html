<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2.6. Customization &mdash; Buildbot 4.0.2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=d10597a4" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/buildbot_rtd.css?v=915d5e18" />

  
    <link rel="shortcut icon" href="../_static/icon.png"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=a084f797"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="2.7. Command-line Tool" href="cmdline.html" />
    <link rel="prev" title="2.5.25.3. TestBuildStepMixin" href="configuration/tests/steps.html" /> 
<!-- GA-TRACKING-START -->
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try{
var pageTracker = _gat._getTracker("UA-12313843-4");
pageTracker._setDomainName("none");
pageTracker._setAllowLinker(true);
pageTracker._trackPageview();
} catch(err) {}
</script>
<!-- GA-TRACKING-END -->
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Buildbot
              <img src="../_static/full_logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                4.0.2
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../tutorial/index.html">1. Buildbot Tutorial</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">2. Buildbot Manual</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="introduction.html">2.1. Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation/index.html">2.2. Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="concepts.html">2.3. Concepts</a></li>
<li class="toctree-l2"><a class="reference internal" href="secretsmanagement.html">2.4. Secret Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration/index.html">2.5. Configuration</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">2.6. Customization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#programmatic-configuration-generation">2.6.1. Programmatic Configuration Generation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#collapse-request-functions">2.6.2. Collapse Request Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#builder-priority-functions">2.6.3. Builder Priority Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#build-priority-functions">2.6.4. Build Priority Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#scheduler-priority-functions">2.6.5. Scheduler Priority Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#canstartbuild-functions">2.6.6. <code class="docutils literal notranslate"><span class="pre">canStartBuild</span></code> Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#customizing-svnpoller">2.6.7. Customizing SVNPoller</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#project-branchname-filepath-repositories">2.6.7.1. <code class="samp docutils literal notranslate"><em><span class="pre">PROJECT</span></em><span class="pre">/</span><em><span class="pre">BRANCHNAME</span></em><span class="pre">/</span><em><span class="pre">FILEPATH</span></em></code> repositories</a></li>
<li class="toctree-l4"><a class="reference internal" href="#branchname-project-filepath-repositories">2.6.7.2. <code class="samp docutils literal notranslate"><em><span class="pre">BRANCHNAME</span></em><span class="pre">/</span><em><span class="pre">PROJECT</span></em><span class="pre">/</span><em><span class="pre">FILEPATH</span></em></code> repositories</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#writing-change-sources">2.6.8. Writing Change Sources</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#writing-a-notification-based-change-source">2.6.8.1. Writing a Notification-based Change Source</a></li>
<li class="toctree-l4"><a class="reference internal" href="#writing-a-change-poller">2.6.8.2. Writing a Change Poller</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#writing-a-new-latent-worker-implementation">2.6.9. Writing a New Latent Worker Implementation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#abstractlatentworker">2.6.9.1. AbstractLatentWorker</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#custom-build-classes">2.6.10. Custom Build Classes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#factory-workdir-functions">2.6.11. Factory Workdir Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#writing-new-buildsteps">2.6.12. Writing New BuildSteps</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#writing-buildstep-constructors">2.6.12.1. Writing BuildStep Constructors</a></li>
<li class="toctree-l4"><a class="reference internal" href="#step-execution-process">2.6.12.2. Step Execution Process</a></li>
<li class="toctree-l4"><a class="reference internal" href="#running-commands">2.6.12.3. Running Commands</a></li>
<li class="toctree-l4"><a class="reference internal" href="#updating-status-strings">2.6.12.4. Updating Status Strings</a></li>
<li class="toctree-l4"><a class="reference internal" href="#about-logfiles">2.6.12.5. About Logfiles</a></li>
<li class="toctree-l4"><a class="reference internal" href="#writing-log-files">2.6.12.6. Writing Log Files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#reading-logfiles">2.6.12.7. Reading Logfiles</a></li>
<li class="toctree-l4"><a class="reference internal" href="#adding-logobservers">2.6.12.8. Adding LogObservers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-properties">2.6.12.9. Using Properties</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-statistics">2.6.12.10. Using Statistics</a></li>
<li class="toctree-l4"><a class="reference internal" href="#buildstep-urls">2.6.12.11. BuildStep URLs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#discovering-files">2.6.12.12. Discovering files</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#writing-dashboards-with-flask-or-bottle">2.6.13. Writing Dashboards with Flask or Bottle</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#buildbot_api.dataGet"><code class="docutils literal notranslate"><span class="pre">buildbot_api.dataGet</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#a-somewhat-whimsical-example-or-it-s-now-customized-how-do-i-deploy-it">2.6.14. A Somewhat Whimsical Example (or “It’s now customized, how do I deploy it?”)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#inclusion-in-the-master-cfg-file">2.6.14.1. Inclusion in the <code class="file docutils literal notranslate"><span class="pre">master.cfg</span></code> file</a></li>
<li class="toctree-l4"><a class="reference internal" href="#python-file-somewhere-on-the-system">2.6.14.2. Python file somewhere on the system</a></li>
<li class="toctree-l4"><a class="reference internal" href="#install-this-code-into-a-standard-python-library-directory">2.6.14.3. Install this code into a standard Python library directory</a></li>
<li class="toctree-l4"><a class="reference internal" href="#distribute-a-buildbot-plug-in">2.6.14.4. Distribute a Buildbot Plug-In</a></li>
<li class="toctree-l4"><a class="reference internal" href="#submit-the-code-for-inclusion-in-the-buildbot-distribution">2.6.14.5. Submit the code for inclusion in the Buildbot distribution</a></li>
<li class="toctree-l4"><a class="reference internal" href="#summary">2.6.14.6. Summary</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cmdline.html">2.7. Command-line Tool</a></li>
<li class="toctree-l2"><a class="reference internal" href="resources.html">2.8. Resources</a></li>
<li class="toctree-l2"><a class="reference internal" href="optimization.html">2.9. Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="plugins.html">2.10. Plugin Infrastructure in Buildbot</a></li>
<li class="toctree-l2"><a class="reference internal" href="deploy.html">2.11. Deployment</a></li>
<li class="toctree-l2"><a class="reference internal" href="upgrading/index.html">2.12. Upgrading</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../developer/index.html">3. Buildbot Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../relnotes/index.html">4. Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../relnotes/index.html#older-release-notes">5. Older Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../indices.html">6. API Indices</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Buildbot</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html"><span class="section-number">2. </span>Buildbot Manual</a></li>
      <li class="breadcrumb-item active"><span class="section-number">2.6. </span>Customization</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/manual/customization.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="customization">
<h1><span class="section-number">2.6. </span>Customization<a class="headerlink" href="#customization" title="Link to this heading"></a></h1>
<p>For advanced users, Buildbot acts as a framework supporting a customized build application.
For the most part, such configurations consist of subclasses set up for use in a regular Buildbot configuration file.</p>
<p>This chapter describes some of the more common idioms in advanced Buildbot configurations.</p>
<p>At the moment, this chapter is an unordered set of suggestions:</p>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#programmatic-configuration-generation" id="id15">Programmatic Configuration Generation</a></p></li>
<li><p><a class="reference internal" href="#collapse-request-functions" id="id16">Collapse Request Functions</a></p></li>
<li><p><a class="reference internal" href="#builder-priority-functions" id="id17">Builder Priority Functions</a></p></li>
<li><p><a class="reference internal" href="#build-priority-functions" id="id18">Build Priority Functions</a></p></li>
<li><p><a class="reference internal" href="#scheduler-priority-functions" id="id19">Scheduler Priority Functions</a></p></li>
<li><p><a class="reference internal" href="#canstartbuild-functions" id="id20"><code class="docutils literal notranslate"><span class="pre">canStartBuild</span></code> Functions</a></p></li>
<li><p><a class="reference internal" href="#customizing-svnpoller" id="id21">Customizing SVNPoller</a></p>
<ul>
<li><p><a class="reference internal" href="#project-branchname-filepath-repositories" id="id22"><code class="samp docutils literal notranslate"><em><span class="pre">PROJECT</span></em><span class="pre">/</span><em><span class="pre">BRANCHNAME</span></em><span class="pre">/</span><em><span class="pre">FILEPATH</span></em></code> repositories</a></p></li>
<li><p><a class="reference internal" href="#branchname-project-filepath-repositories" id="id23"><code class="samp docutils literal notranslate"><em><span class="pre">BRANCHNAME</span></em><span class="pre">/</span><em><span class="pre">PROJECT</span></em><span class="pre">/</span><em><span class="pre">FILEPATH</span></em></code> repositories</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#writing-change-sources" id="id24">Writing Change Sources</a></p>
<ul>
<li><p><a class="reference internal" href="#writing-a-notification-based-change-source" id="id25">Writing a Notification-based Change Source</a></p></li>
<li><p><a class="reference internal" href="#writing-a-change-poller" id="id26">Writing a Change Poller</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#writing-a-new-latent-worker-implementation" id="id27">Writing a New Latent Worker Implementation</a></p>
<ul>
<li><p><a class="reference internal" href="#abstractlatentworker" id="id28">AbstractLatentWorker</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#custom-build-classes" id="id29">Custom Build Classes</a></p></li>
<li><p><a class="reference internal" href="#factory-workdir-functions" id="id30">Factory Workdir Functions</a></p></li>
<li><p><a class="reference internal" href="#writing-new-buildsteps" id="id31">Writing New BuildSteps</a></p>
<ul>
<li><p><a class="reference internal" href="#writing-buildstep-constructors" id="id32">Writing BuildStep Constructors</a></p></li>
<li><p><a class="reference internal" href="#step-execution-process" id="id33">Step Execution Process</a></p></li>
<li><p><a class="reference internal" href="#running-commands" id="id34">Running Commands</a></p></li>
<li><p><a class="reference internal" href="#updating-status-strings" id="id35">Updating Status Strings</a></p></li>
<li><p><a class="reference internal" href="#about-logfiles" id="id36">About Logfiles</a></p></li>
<li><p><a class="reference internal" href="#writing-log-files" id="id37">Writing Log Files</a></p></li>
<li><p><a class="reference internal" href="#reading-logfiles" id="id38">Reading Logfiles</a></p></li>
<li><p><a class="reference internal" href="#adding-logobservers" id="id39">Adding LogObservers</a></p></li>
<li><p><a class="reference internal" href="#using-properties" id="id40">Using Properties</a></p></li>
<li><p><a class="reference internal" href="#using-statistics" id="id41">Using Statistics</a></p></li>
<li><p><a class="reference internal" href="#buildstep-urls" id="id42">BuildStep URLs</a></p></li>
<li><p><a class="reference internal" href="#discovering-files" id="id43">Discovering files</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#writing-dashboards-with-flask-or-bottle" id="id44">Writing Dashboards with Flask or Bottle</a></p></li>
<li><p><a class="reference internal" href="#a-somewhat-whimsical-example-or-it-s-now-customized-how-do-i-deploy-it" id="id45">A Somewhat Whimsical Example (or “It’s now customized, how do I deploy it?”)</a></p>
<ul>
<li><p><a class="reference internal" href="#inclusion-in-the-master-cfg-file" id="id46">Inclusion in the <code class="file docutils literal notranslate"><span class="pre">master.cfg</span></code> file</a></p></li>
<li><p><a class="reference internal" href="#python-file-somewhere-on-the-system" id="id47">Python file somewhere on the system</a></p></li>
<li><p><a class="reference internal" href="#install-this-code-into-a-standard-python-library-directory" id="id48">Install this code into a standard Python library directory</a></p></li>
<li><p><a class="reference internal" href="#distribute-a-buildbot-plug-in" id="id49">Distribute a Buildbot Plug-In</a></p></li>
<li><p><a class="reference internal" href="#submit-the-code-for-inclusion-in-the-buildbot-distribution" id="id50">Submit the code for inclusion in the Buildbot distribution</a></p></li>
<li><p><a class="reference internal" href="#summary" id="id51">Summary</a></p></li>
</ul>
</li>
</ul>
</nav>
<p>If you’d like to clean it up, fork the project on GitHub and get started!</p>
<section id="programmatic-configuration-generation">
<h2><a class="toc-backref" href="#id15" role="doc-backlink"><span class="section-number">2.6.1. </span>Programmatic Configuration Generation</a><a class="headerlink" href="#programmatic-configuration-generation" title="Link to this heading"></a></h2>
<p>Bearing in mind that <code class="docutils literal notranslate"><span class="pre">master.cfg</span></code> is a Python file, large configurations can be shortened considerably by judicious use of Python loops.
For example, the following will generate a builder for each of a range of supported versions of Python:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pythons</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;python2.4&#39;</span><span class="p">,</span> <span class="s1">&#39;python2.5&#39;</span><span class="p">,</span> <span class="s1">&#39;python2.6&#39;</span><span class="p">,</span> <span class="s1">&#39;python2.7&#39;</span><span class="p">,</span>
           <span class="s1">&#39;python3.2&#39;</span><span class="p">,</span> <span class="s1">&#39;python3.3&#39;</span><span class="p">]</span>
<span class="n">pytest_workers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;worker</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">python</span> <span class="ow">in</span> <span class="n">pythons</span><span class="p">:</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">BuildFactory</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">addStep</span><span class="p">(</span><span class="n">steps</span><span class="o">.</span><span class="n">SVN</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>
    <span class="n">f</span><span class="o">.</span><span class="n">addStep</span><span class="p">(</span><span class="n">steps</span><span class="o">.</span><span class="n">ShellCommand</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="p">[</span><span class="n">python</span><span class="p">,</span> <span class="s1">&#39;test.py&#39;</span><span class="p">]))</span>
    <span class="n">c</span><span class="p">[</span><span class="s1">&#39;builders&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">BuilderConfig</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;test-</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">python</span><span class="p">,</span>
            <span class="n">factory</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
            <span class="n">workernames</span><span class="o">=</span><span class="n">pytest_workers</span><span class="p">))</span>
</pre></div>
</div>
<p>Next step would be the loading of <code class="docutils literal notranslate"><span class="pre">pythons</span></code> list from a .yaml/.ini file.</p>
</section>
<section id="collapse-request-functions">
<span id="id1"></span><h2><a class="toc-backref" href="#id16" role="doc-backlink"><span class="section-number">2.6.2. </span>Collapse Request Functions</a><a class="headerlink" href="#collapse-request-functions" title="Link to this heading"></a></h2>
<p id="index-0">The logic Buildbot uses to decide which build request can be merged can be customized by providing a Python function (a callable) instead of <code class="docutils literal notranslate"><span class="pre">True</span></code> or <code class="docutils literal notranslate"><span class="pre">False</span></code> described in <a class="reference internal" href="configuration/builders.html#collapsing-build-requests"><span class="std std-ref">Collapsing Build Requests</span></a>.</p>
<p>Arguments for the callable are:</p>
<blockquote>
<div><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">master</span></code></dt><dd><p>pointer to the master object, which can be used to make additional data api calls via <cite>master.data.get</cite></p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">builder</span></code></dt><dd><p>dictionary of type <a class="reference internal" href="../developer/raml/builder.html#rtype-builder" title="builder"><code class="xref bb bb-rtype docutils literal notranslate"><span class="pre">builder</span></code></a></p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">req1</span></code></dt><dd><p>dictionary of type <a class="reference internal" href="../developer/raml/buildrequest.html#rtype-buildrequest" title="buildrequest"><code class="xref bb bb-rtype docutils literal notranslate"><span class="pre">buildrequest</span></code></a></p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">req2</span></code></dt><dd><p>dictionary of type <a class="reference internal" href="../developer/raml/buildrequest.html#rtype-buildrequest" title="buildrequest"><code class="xref bb bb-rtype docutils literal notranslate"><span class="pre">buildrequest</span></code></a></p>
</dd>
</dl>
</div></blockquote>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The number of invocations of the callable is proportional to the square of the request queue length, so a long-running callable may cause undesirable delays when the queue length grows.</p>
</div>
<p>It should return true if the requests can be merged, and False otherwise.
For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@defer</span><span class="o">.</span><span class="n">inlineCallbacks</span>
<span class="k">def</span> <span class="nf">collapseRequests</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">req1</span><span class="p">,</span> <span class="n">req2</span><span class="p">):</span>
    <span class="s2">&quot;any requests with the same branch can be merged&quot;</span>

    <span class="c1"># get the buildsets for each buildrequest</span>
    <span class="n">selfBuildset</span> <span class="p">,</span> <span class="n">otherBuildset</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">defer</span><span class="o">.</span><span class="n">gatherResults</span><span class="p">([</span>
        <span class="n">master</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="s1">&#39;buildsets&#39;</span><span class="p">,</span> <span class="n">req1</span><span class="p">[</span><span class="s1">&#39;buildsetid&#39;</span><span class="p">])),</span>
        <span class="n">master</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="s1">&#39;buildsets&#39;</span><span class="p">,</span> <span class="n">req2</span><span class="p">[</span><span class="s1">&#39;buildsetid&#39;</span><span class="p">]))</span>
        <span class="p">])</span>
    <span class="n">selfSourcestamps</span> <span class="o">=</span> <span class="n">selfBuildset</span><span class="p">[</span><span class="s1">&#39;sourcestamps&#39;</span><span class="p">]</span>
    <span class="n">otherSourcestamps</span> <span class="o">=</span> <span class="n">otherBuildset</span><span class="p">[</span><span class="s1">&#39;sourcestamps&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selfSourcestamps</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">otherSourcestamps</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">for</span> <span class="n">selfSourcestamp</span><span class="p">,</span> <span class="n">otherSourcestamp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">selfSourcestamps</span><span class="p">,</span> <span class="n">otherSourcestamps</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">selfSourcestamp</span><span class="p">[</span><span class="s1">&#39;branch&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">otherSourcestamp</span><span class="p">[</span><span class="s1">&#39;branch&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span>

<span class="n">c</span><span class="p">[</span><span class="s1">&#39;collapseRequests&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collapseRequests</span>
</pre></div>
</div>
<p>In many cases, the details of the <a class="reference internal" href="../developer/raml/sourcestamp.html#rtype-sourcestamp" title="sourcestamp"><code class="xref bb bb-rtype docutils literal notranslate"><span class="pre">sourcestamp</span></code></a> and <a class="reference internal" href="../developer/raml/buildrequest.html#rtype-buildrequest" title="buildrequest"><code class="xref bb bb-rtype docutils literal notranslate"><span class="pre">buildrequest</span></code></a> are important.</p>
<p>In the following example, only <a class="reference internal" href="../developer/raml/buildrequest.html#rtype-buildrequest" title="buildrequest"><code class="xref bb bb-rtype docutils literal notranslate"><span class="pre">buildrequest</span></code></a> with the same “reason” are merged; thus developers forcing builds for different reasons will see distinct builds.</p>
<p>Note the use of the <code class="xref py py-meth docutils literal notranslate"><span class="pre">buildrequest.BuildRequest.canBeCollapsed</span></code> method to access the source stamp compatibility algorithm:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@defer</span><span class="o">.</span><span class="n">inlineCallbacks</span>
<span class="k">def</span> <span class="nf">collapseRequests</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">req1</span><span class="p">,</span> <span class="n">req2</span><span class="p">):</span>
    <span class="n">canBeCollapsed</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">buildrequest</span><span class="o">.</span><span class="n">BuildRequest</span><span class="o">.</span><span class="n">canBeCollapsed</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">req1</span><span class="p">,</span> <span class="n">req2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">canBeCollapsed</span> <span class="ow">and</span> <span class="n">req1</span><span class="o">.</span><span class="n">reason</span> <span class="o">==</span> <span class="n">req2</span><span class="o">.</span><span class="n">reason</span><span class="p">:</span>
       <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
       <span class="k">return</span> <span class="kc">False</span>
<span class="n">c</span><span class="p">[</span><span class="s1">&#39;collapseRequests&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collapseRequests</span>
</pre></div>
</div>
<p>Another common example is to prevent collapsing of requests coming from a <a class="reference internal" href="configuration/steps/trigger.html#step-Trigger" title="Trigger"><code class="xref bb bb-step docutils literal notranslate"><span class="pre">Trigger</span></code></a> step.
<a class="reference internal" href="configuration/steps/trigger.html#step-Trigger" title="Trigger"><code class="xref bb bb-step docutils literal notranslate"><span class="pre">Trigger</span></code></a> step can indeed be used in order to implement parallel testing of the same source.</p>
<p>Buildrequests will all have the same sourcestamp, but probably different properties, and shall not be collapsed.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In most cases, just setting <code class="docutils literal notranslate"><span class="pre">collapseRequests=False</span></code> for triggered builders will do the trick.</p>
</div>
<p>In other cases, <code class="docutils literal notranslate"><span class="pre">parent_buildid</span></code> from buildset can be used:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@defer</span><span class="o">.</span><span class="n">inlineCallbacks</span>
<span class="k">def</span> <span class="nf">collapseRequests</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">req1</span><span class="p">,</span> <span class="n">req2</span><span class="p">):</span>
    <span class="n">canBeCollapsed</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">buildrequest</span><span class="o">.</span><span class="n">BuildRequest</span><span class="o">.</span><span class="n">canBeCollapsed</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">req1</span><span class="p">,</span> <span class="n">req2</span><span class="p">)</span>
    <span class="n">selfBuildset</span> <span class="p">,</span> <span class="n">otherBuildset</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">defer</span><span class="o">.</span><span class="n">gatherResults</span><span class="p">([</span>
        <span class="n">master</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="s1">&#39;buildsets&#39;</span><span class="p">,</span> <span class="n">req1</span><span class="p">[</span><span class="s1">&#39;buildsetid&#39;</span><span class="p">])),</span>
        <span class="n">master</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="s1">&#39;buildsets&#39;</span><span class="p">,</span> <span class="n">req2</span><span class="p">[</span><span class="s1">&#39;buildsetid&#39;</span><span class="p">]))</span>
    <span class="p">])</span>
    <span class="k">if</span> <span class="n">canBeCollapsed</span> <span class="ow">and</span> <span class="n">selfBuildset</span><span class="p">[</span><span class="s1">&#39;parent_buildid&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> \
            <span class="n">otherBuildset</span><span class="p">[</span><span class="s1">&#39;parent_buildid&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
<span class="n">c</span><span class="p">[</span><span class="s1">&#39;collapseRequests&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collapseRequests</span>
</pre></div>
</div>
<p>If it’s necessary to perform some extended operation to determine whether two requests can be merged, then the <code class="docutils literal notranslate"><span class="pre">collapseRequests</span></code> callable may return its result via Deferred.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Again, the number of invocations of the callable is proportional to the square of the request queue length, so a long-running callable may cause undesirable delays when the queue length grows.</p>
</div>
<p>For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@defer</span><span class="o">.</span><span class="n">inlineCallbacks</span>
<span class="k">def</span> <span class="nf">collapseRequests</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">req1</span><span class="p">,</span> <span class="n">req2</span><span class="p">):</span>
    <span class="n">info1</span><span class="p">,</span> <span class="n">info2</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">defer</span><span class="o">.</span><span class="n">gatherResults</span><span class="p">([</span>
        <span class="n">getMergeInfo</span><span class="p">(</span><span class="n">req1</span><span class="p">),</span>
        <span class="n">getMergeInfo</span><span class="p">(</span><span class="n">req2</span><span class="p">),</span>
    <span class="p">])</span>
    <span class="k">return</span> <span class="n">info1</span> <span class="o">==</span> <span class="n">info2</span>

<span class="n">c</span><span class="p">[</span><span class="s1">&#39;collapseRequests&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collapseRequests</span>
</pre></div>
</div>
</section>
<section id="builder-priority-functions">
<span id="id2"></span><h2><a class="toc-backref" href="#id17" role="doc-backlink"><span class="section-number">2.6.3. </span>Builder Priority Functions</a><a class="headerlink" href="#builder-priority-functions" title="Link to this heading"></a></h2>
<p id="index-1">The <a class="reference internal" href="configuration/global.html#cfg-prioritizeBuilders" title="prioritizeBuilders"><code class="xref bb bb-cfg docutils literal notranslate"><span class="pre">prioritizeBuilders</span></code></a> configuration key specifies a function which is called with two arguments: a <code class="xref py py-class docutils literal notranslate"><span class="pre">BuildMaster</span></code> and a list of <code class="xref py py-class docutils literal notranslate"><span class="pre">Builder</span></code> objects.
It should return a list of the same <code class="xref py py-class docutils literal notranslate"><span class="pre">Builder</span></code> objects, in the desired order.
It may also remove items from the list if builds should not be started on those builders.
If necessary, this function can return its results via a Deferred (it is called with <code class="docutils literal notranslate"><span class="pre">maybeDeferred</span></code>).</p>
<p>A simple <code class="docutils literal notranslate"><span class="pre">prioritizeBuilders</span></code> implementation might look like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">prioritizeBuilders</span><span class="p">(</span><span class="n">buildmaster</span><span class="p">,</span> <span class="n">builders</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prioritize builders. &#39;finalRelease&#39; builds have the highest</span>
<span class="sd">    priority, so they should be built before running tests, or</span>
<span class="sd">    creating builds.&quot;&quot;&quot;</span>
    <span class="n">builderPriorities</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;finalRelease&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;build&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">builders</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">b</span><span class="p">:</span> <span class="n">builderPriorities</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">builders</span>

<span class="n">c</span><span class="p">[</span><span class="s1">&#39;prioritizeBuilders&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prioritizeBuilders</span>
</pre></div>
</div>
<p>If the change frequency is higher than the turn-around of the builders,
the following approach might be helpful:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">buildbot.util.async_sort</span> <span class="kn">import</span> <span class="n">async_sort</span>
<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">defer</span>

<span class="nd">@defer</span><span class="o">.</span><span class="n">inlineCallbacks</span>
<span class="k">def</span> <span class="nf">prioritizeBuilders</span><span class="p">(</span><span class="n">buildmaster</span><span class="p">,</span> <span class="n">builders</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prioritize builders. First, prioritize inactive builders.</span>
<span class="sd">    Second, consider the last time a job was completed (no job is infinite past).</span>
<span class="sd">    Third, consider the time the oldest request has been queued.</span>
<span class="sd">    This provides a simple round-robin scheme that works with collapsed builds.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">isBuilding</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">building</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">bool</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">old_building</span><span class="p">)</span>

    <span class="nd">@defer</span><span class="o">.</span><span class="n">inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">key</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
        <span class="n">newest_complete_time</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">b</span><span class="o">.</span><span class="n">getNewestCompleteTime</span><span class="p">()</span>
        <span class="n">oldest_request_time</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">b</span><span class="o">.</span><span class="n">getOldestRequestTime</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">isBuilding</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">newest_complete_time</span><span class="p">,</span> <span class="n">oldest_request_time</span><span class="p">)</span>

    <span class="n">async_sort</span><span class="p">(</span><span class="n">builders</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">builders</span>

<span class="n">c</span><span class="p">[</span><span class="s1">&#39;prioritizeBuilders&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prioritizeBuilders</span>
</pre></div>
</div>
</section>
<section id="build-priority-functions">
<span id="index-2"></span><span id="id3"></span><h2><a class="toc-backref" href="#id18" role="doc-backlink"><span class="section-number">2.6.4. </span>Build Priority Functions</a><a class="headerlink" href="#build-priority-functions" title="Link to this heading"></a></h2>
<p>When a builder has multiple pending build requests, it uses a <code class="docutils literal notranslate"><span class="pre">nextBuild</span></code> function to decide which build it should start first.
This function is given two parameters: the <code class="xref py py-class docutils literal notranslate"><span class="pre">Builder</span></code>, and a list of <code class="xref py py-class docutils literal notranslate"><span class="pre">BuildRequest</span></code> objects representing pending build requests.</p>
<p>A simple function to prioritize release builds over other builds might look like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">nextBuild</span><span class="p">(</span><span class="n">bldr</span><span class="p">,</span> <span class="n">requests</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">requests</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">branch</span> <span class="o">==</span> <span class="s1">&#39;release&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">r</span>
    <span class="k">return</span> <span class="n">requests</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p>If some non-immediate result must be calculated, the <code class="docutils literal notranslate"><span class="pre">nextBuild</span></code> function can also return a Deferred:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">nextBuild</span><span class="p">(</span><span class="n">bldr</span><span class="p">,</span> <span class="n">requests</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">get_request_priorities</span><span class="p">(</span><span class="n">requests</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">pick</span><span class="p">(</span><span class="n">priorities</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">requests</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">priorities</span><span class="p">,</span> <span class="n">requests</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">pick</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">d</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">nextBuild</span></code> function is passed as parameter to <code class="xref py py-class docutils literal notranslate"><span class="pre">BuilderConfig</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span> <span class="n">BuilderConfig</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">nextBuild</span><span class="o">=</span><span class="n">nextBuild</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span> <span class="o">...</span>
</pre></div>
</div>
</section>
<section id="scheduler-priority-functions">
<span id="index-3"></span><span id="id4"></span><h2><a class="toc-backref" href="#id19" role="doc-backlink"><span class="section-number">2.6.5. </span>Scheduler Priority Functions</a><a class="headerlink" href="#scheduler-priority-functions" title="Link to this heading"></a></h2>
<p>When a <code class="xref py py-class docutils literal notranslate"><span class="pre">Scheduler</span></code> is creating a a new <code class="xref py py-class docutils literal notranslate"><span class="pre">BuildRequest</span></code> from a (list of) <code class="xref py py-class docutils literal notranslate"><span class="pre">Change</span></code> (s),it is possible to set the <code class="xref py py-class docutils literal notranslate"><span class="pre">BuildRequest</span></code> priority.
This can either be an integer or a function, which receives a list of builder names and a dictionary of <code class="xref py py-class docutils literal notranslate"><span class="pre">Change</span></code>, grouped by their codebase.</p>
<p>A simple implementation might look like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">scheduler_priority</span><span class="p">(</span><span class="n">builderNames</span><span class="p">,</span> <span class="n">changesByCodebase</span><span class="p">):</span>
     <span class="n">priority</span> <span class="o">=</span> <span class="mi">0</span>

     <span class="k">for</span> <span class="n">codebase</span><span class="p">,</span> <span class="n">changes</span> <span class="ow">in</span> <span class="n">changesByCodebase</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
         <span class="k">for</span> <span class="n">chg</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">:</span>
             <span class="k">if</span> <span class="n">chg</span><span class="p">[</span><span class="s2">&quot;branch&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;dev/&quot;</span><span class="p">):</span>
                     <span class="n">priority</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">priority</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
             <span class="k">elif</span> <span class="n">chg</span><span class="p">[</span><span class="s2">&quot;branch&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;bugfix/&quot;</span><span class="p">):</span>
                     <span class="n">priority</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">priority</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
             <span class="k">elif</span> <span class="n">chg</span><span class="p">[</span><span class="s2">&quot;branch&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;main&quot;</span><span class="p">:</span>
                     <span class="n">priority</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">priority</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

     <span class="k">return</span> <span class="n">priority</span>
</pre></div>
</div>
<p>The priority function/integer can be passed as a parameter to <code class="xref py py-class docutils literal notranslate"><span class="pre">Scheduler</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span> <span class="n">schedulers</span><span class="o">.</span><span class="n">SingleBranchScheduler</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="n">scheduler_priority</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span> <span class="o">...</span>
</pre></div>
</div>
</section>
<section id="canstartbuild-functions">
<span id="id5"></span><h2><a class="toc-backref" href="#id20" role="doc-backlink"><span class="section-number">2.6.6. </span><code class="docutils literal notranslate"><span class="pre">canStartBuild</span></code> Functions</a><a class="headerlink" href="#canstartbuild-functions" title="Link to this heading"></a></h2>
<p>Sometimes, you cannot know in advance what workers to assign to a <code class="xref py py-class docutils literal notranslate"><span class="pre">BuilderConfig</span></code>.
For example, you might need to check for the existence of a file on a worker before running a build on it.
It is possible to do that by setting the <code class="docutils literal notranslate"><span class="pre">canStartBuild</span></code> callback.</p>
<p>Here is an example that checks if there is a <code class="docutils literal notranslate"><span class="pre">vm</span></code> property set for the build request.
If it is set, it checks if a file named after it exists in the <code class="docutils literal notranslate"><span class="pre">/opt/vm</span></code> folder.
If the file does not exist on the given worker, refuse to run the build to force the master to select another worker.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@defer</span><span class="o">.</span><span class="n">inlineCallbacks</span>
<span class="k">def</span> <span class="nf">canStartBuild</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">wfb</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>

    <span class="n">vm</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vm&#39;</span><span class="p">,</span> <span class="n">builder</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vm&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">vm</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/opt/vm&#39;</span><span class="p">,</span> <span class="n">vm</span><span class="p">)}</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">RemoteCommand</span><span class="p">(</span><span class="s1">&#39;stat&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">stdioLogName</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">worker</span> <span class="o">=</span> <span class="n">wfb</span><span class="o">.</span><span class="n">worker</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">cmd</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">wfb</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">conn</span><span class="p">,</span> <span class="n">builder</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span>
</pre></div>
</div>
<p>Here is a more complete example that checks if a worker is fit to start a build.
If the load average is higher than the number of CPU cores or if there is less than 2GB of free memory, refuse to run the build on that worker.
Also, put that worker in quarantine to make sure no other builds are scheduled on it for a while.
Otherwise, let the build start on that worker.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FakeBuild</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">properties</span> <span class="o">=</span> <span class="n">Properties</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">FakeStep</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">build</span> <span class="o">=</span> <span class="n">FakeBuild</span><span class="p">()</span>

<span class="nd">@defer</span><span class="o">.</span><span class="n">inlineCallbacks</span>
<span class="k">def</span> <span class="nf">shell</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">worker</span><span class="p">,</span> <span class="n">builder</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;command&#39;</span><span class="p">:</span> <span class="n">command</span><span class="p">,</span>
        <span class="s1">&#39;logEnviron&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;workdir&#39;</span><span class="p">:</span> <span class="n">worker</span><span class="o">.</span><span class="n">worker_basedir</span><span class="p">,</span>
        <span class="s1">&#39;want_stdout&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;want_stderr&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">RemoteCommand</span><span class="p">(</span><span class="s1">&#39;shell&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">stdioLogName</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">cmd</span><span class="o">.</span><span class="n">worker</span> <span class="o">=</span> <span class="n">worker</span>
    <span class="k">yield</span> <span class="n">cmd</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">FakeStep</span><span class="p">(),</span> <span class="n">worker</span><span class="o">.</span><span class="n">conn</span><span class="p">,</span> <span class="n">builder</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cmd</span><span class="o">.</span><span class="n">rc</span>

<span class="nd">@defer</span><span class="o">.</span><span class="n">inlineCallbacks</span>
<span class="k">def</span> <span class="nf">canStartBuild</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">wfb</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="c1"># check that load is not too high</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">shell</span><span class="p">(</span>
        <span class="s1">&#39;test &quot;$(cut -d. -f1 /proc/loadavg)&quot; -le &quot;$(nproc)&quot;&#39;</span><span class="p">,</span>
        <span class="n">wfb</span><span class="o">.</span><span class="n">worker</span><span class="p">,</span> <span class="n">builder</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;loadavg is too high to take new builds&#39;</span><span class="p">,</span>
                <span class="n">system</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">wfb</span><span class="o">.</span><span class="n">worker</span><span class="p">))</span>
        <span class="n">wfb</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">putInQuarantine</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># check there is enough free memory</span>
    <span class="n">sed_expr</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;s/^MemAvailable:[[:space:]]+([0-9]+)[[:space:]]+kB$/\1/p&#39;</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">shell</span><span class="p">(</span>
        <span class="s1">&#39;test &quot;$(sed -nre </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1"> /proc/meminfo)&quot; -gt 2000000&#39;</span> <span class="o">%</span> <span class="n">sed_expr</span><span class="p">,</span>
        <span class="n">wfb</span><span class="o">.</span><span class="n">worker</span><span class="p">,</span> <span class="n">builder</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;not enough free memory to take new builds&#39;</span><span class="p">,</span>
                <span class="n">system</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">wfb</span><span class="o">.</span><span class="n">worker</span><span class="p">))</span>
        <span class="n">wfb</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">putInQuarantine</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># The build may now proceed.</span>
    <span class="c1">#</span>
    <span class="c1"># Prevent this worker from taking any other build while this one is</span>
    <span class="c1"># starting for 2 min. This leaves time for the build to start consuming</span>
    <span class="c1"># resources (disk, memory, cpu). When the quarantine is over, if the</span>
    <span class="c1"># same worker is subject to start another build, the above checks will</span>
    <span class="c1"># better reflect the actual state of the worker.</span>
    <span class="n">wfb</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">quarantine_timeout</span> <span class="o">=</span> <span class="mi">120</span>
    <span class="n">wfb</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">putInQuarantine</span><span class="p">()</span>

    <span class="c1"># This does not take the worker out of quarantine, it only resets the</span>
    <span class="c1"># timeout value to default.</span>
    <span class="n">wfb</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">resetQuarantine</span><span class="p">()</span>

    <span class="k">return</span> <span class="kc">True</span>
</pre></div>
</div>
<p>You can extend these examples using any remote command described in the <a class="reference internal" href="../developer/master-worker.html"><span class="doc">Master-Worker API</span></a>.</p>
</section>
<section id="customizing-svnpoller">
<span id="id6"></span><h2><a class="toc-backref" href="#id21" role="doc-backlink"><span class="section-number">2.6.7. </span>Customizing SVNPoller</a><a class="headerlink" href="#customizing-svnpoller" title="Link to this heading"></a></h2>
<p>Each source file that is tracked by a Subversion repository has a fully-qualified SVN URL in the following form: <code class="samp docutils literal notranslate"><span class="pre">(</span><em><span class="pre">REPOURL</span></em><span class="pre">)(</span><em><span class="pre">PROJECT-plus-BRANCH</span></em><span class="pre">)(</span><em><span class="pre">FILEPATH</span></em><span class="pre">)</span></code>.
When you create the <a class="reference internal" href="configuration/changesources.html#chsrc-SVNPoller" title="SVNPoller"><code class="xref bb bb-chsrc docutils literal notranslate"><span class="pre">SVNPoller</span></code></a>, you give it a <code class="docutils literal notranslate"><span class="pre">repourl</span></code> value that includes all of the <code class="samp docutils literal notranslate"><em><span class="pre">REPOURL</span></em></code> and possibly some portion of the <code class="samp docutils literal notranslate"><em><span class="pre">PROJECT-plus-BRANCH</span></em></code> string.
The <a class="reference internal" href="configuration/changesources.html#chsrc-SVNPoller" title="SVNPoller"><code class="xref bb bb-chsrc docutils literal notranslate"><span class="pre">SVNPoller</span></code></a> is responsible for producing Changes that contain a branch name and a <code class="samp docutils literal notranslate"><em><span class="pre">FILEPATH</span></em></code> (which is relative to the top of a checked-out tree).
The details of how these strings are split up depend upon how your repository names its branches.</p>
<section id="project-branchname-filepath-repositories">
<h3><a class="toc-backref" href="#id22" role="doc-backlink"><span class="section-number">2.6.7.1. </span><code class="samp docutils literal notranslate"><em><span class="pre">PROJECT</span></em><span class="pre">/</span><em><span class="pre">BRANCHNAME</span></em><span class="pre">/</span><em><span class="pre">FILEPATH</span></em></code> repositories</a><a class="headerlink" href="#project-branchname-filepath-repositories" title="Link to this heading"></a></h3>
<p>One common layout is to have all the various projects that share a repository get a single top-level directory each, with <code class="docutils literal notranslate"><span class="pre">branches</span></code>, <code class="docutils literal notranslate"><span class="pre">tags</span></code>, and <code class="docutils literal notranslate"><span class="pre">trunk</span></code> subdirectories:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>amanda/trunk
      /branches/3_2
               /3_3
      /tags/3_2_1
           /3_2_2
           /3_3_0
</pre></div>
</div>
<p>To set up a <a class="reference internal" href="configuration/changesources.html#chsrc-SVNPoller" title="SVNPoller"><code class="xref bb bb-chsrc docutils literal notranslate"><span class="pre">SVNPoller</span></code></a> that watches the Amanda trunk (and nothing else), we would use the following, using the default <code class="docutils literal notranslate"><span class="pre">split_file</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">buildbot.plugins</span> <span class="kn">import</span> <span class="n">changes</span>
<span class="n">c</span><span class="p">[</span><span class="s1">&#39;change_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">changes</span><span class="o">.</span><span class="n">SVNPoller</span><span class="p">(</span>
   <span class="n">repourl</span><span class="o">=</span><span class="s2">&quot;https://svn.amanda.sourceforge.net/svnroot/amanda/amanda/trunk&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>In this case, every Change that our <a class="reference internal" href="configuration/changesources.html#chsrc-SVNPoller" title="SVNPoller"><code class="xref bb bb-chsrc docutils literal notranslate"><span class="pre">SVNPoller</span></code></a> produces will have its branch attribute set to <code class="docutils literal notranslate"><span class="pre">None</span></code>, to indicate that the Change is on the trunk.
No other sub-projects or branches will be tracked.</p>
<p>If we want our ChangeSource to follow multiple branches, we have to do two things.
First we have to change our <code class="docutils literal notranslate"><span class="pre">repourl=</span></code> argument to watch more than just <code class="docutils literal notranslate"><span class="pre">amanda/trunk</span></code>.
We will set it to <code class="docutils literal notranslate"><span class="pre">amanda</span></code> so that we’ll see both the trunk and all the branches.
Second, we have to tell <a class="reference internal" href="configuration/changesources.html#chsrc-SVNPoller" title="SVNPoller"><code class="xref bb bb-chsrc docutils literal notranslate"><span class="pre">SVNPoller</span></code></a> how to split the <code class="samp docutils literal notranslate"><span class="pre">(</span><em><span class="pre">PROJECT-plus-BRANCH</span></em><span class="pre">)(</span><em><span class="pre">FILEPATH</span></em><span class="pre">)</span></code> strings it gets from the repository out into <code class="samp docutils literal notranslate"><span class="pre">(</span><em><span class="pre">BRANCH</span></em><span class="pre">)</span></code> and <code class="samp docutils literal notranslate"><span class="pre">(</span><em><span class="pre">FILEPATH</span></em><span class="pre">)</span></code>.</p>
<p>We do the latter by providing a <code class="docutils literal notranslate"><span class="pre">split_file</span></code> function.
This function is responsible for splitting something like <code class="docutils literal notranslate"><span class="pre">branches/3_3/common-src/amanda.h</span></code> into <code class="docutils literal notranslate"><span class="pre">branch='branches/3_3'</span></code> and <code class="docutils literal notranslate"><span class="pre">filepath='common-src/amanda.h'</span></code>.
The function is always given a string that names a file relative to the subdirectory pointed to by the <a class="reference internal" href="configuration/changesources.html#chsrc-SVNPoller" title="SVNPoller"><code class="xref bb bb-chsrc docutils literal notranslate"><span class="pre">SVNPoller</span></code></a>'s <code class="docutils literal notranslate"><span class="pre">repourl=</span></code> argument.
It is expected to return a dictionary with at least the <code class="docutils literal notranslate"><span class="pre">path</span></code> key.
The splitter may optionally set <code class="docutils literal notranslate"><span class="pre">branch</span></code>, <code class="docutils literal notranslate"><span class="pre">project</span></code> and <code class="docutils literal notranslate"><span class="pre">repository</span></code>.
For backwards compatibility it may return a tuple of <code class="docutils literal notranslate"><span class="pre">(branchname,</span> <span class="pre">path)</span></code>.
It may also return <code class="docutils literal notranslate"><span class="pre">None</span></code> to indicate that the file is of no interest.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The function should return <code class="docutils literal notranslate"><span class="pre">branches/3_3</span></code> rather than just <code class="docutils literal notranslate"><span class="pre">3_3</span></code> because the SVN checkout step, will append the branch name to the <code class="docutils literal notranslate"><span class="pre">baseURL</span></code>, which requires that we keep the <code class="docutils literal notranslate"><span class="pre">branches</span></code> component in there.
Other VC schemes use a different approach towards branches and may not require this artifact.</p>
</div>
<p>If your repository uses this same <code class="docutils literal notranslate"><span class="pre">{PROJECT}/{BRANCH}/{FILEPATH}</span></code> naming scheme, the following function will work:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">split_file_branches</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">pieces</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pieces</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">pieces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;trunk&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pieces</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">pieces</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">pieces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;branches&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pieces</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]),</span>
                <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pieces</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
</pre></div>
</div>
<p>In fact, this is the definition of the provided <code class="docutils literal notranslate"><span class="pre">split_file_branches</span></code> function.
So to have our Twisted-watching <a class="reference internal" href="configuration/changesources.html#chsrc-SVNPoller" title="SVNPoller"><code class="xref bb bb-chsrc docutils literal notranslate"><span class="pre">SVNPoller</span></code></a> follow multiple branches, we would use this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">buildbot.plugins</span> <span class="kn">import</span> <span class="n">changes</span><span class="p">,</span> <span class="n">util</span>
<span class="n">c</span><span class="p">[</span><span class="s1">&#39;change_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">changes</span><span class="o">.</span><span class="n">SVNPoller</span><span class="p">(</span><span class="s2">&quot;svn://svn.twistedmatrix.com/svn/Twisted&quot;</span><span class="p">,</span>
                                       <span class="n">split_file</span><span class="o">=</span><span class="n">util</span><span class="o">.</span><span class="n">svn</span><span class="o">.</span><span class="n">split_file_branches</span><span class="p">)</span>
</pre></div>
</div>
<p>Changes for all sorts of branches (with names like <code class="docutils literal notranslate"><span class="pre">&quot;branches/1.5.x&quot;</span></code>, and <code class="docutils literal notranslate"><span class="pre">None</span></code> to indicate the trunk) will be delivered to the Schedulers.
Each Scheduler is then free to use or ignore each branch as it sees fit.</p>
<p>If you have multiple projects in the same repository your split function can attach a project name to the Change to help the Scheduler filter out unwanted changes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">buildbot.plugins</span> <span class="kn">import</span> <span class="n">util</span>
<span class="k">def</span> <span class="nf">split_file_projects_branches</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">project</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">svn</span><span class="o">.</span><span class="n">split_file_branches</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;project&quot;</span><span class="p">:</span> <span class="n">project</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span>
        <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">info</span><span class="p">[</span><span class="s1">&#39;branch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">info</span>
    <span class="k">return</span> <span class="n">f</span>
</pre></div>
</div>
<p>Again, this is provided by default.
To use it you would do this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">buildbot.plugins</span> <span class="kn">import</span> <span class="n">changes</span><span class="p">,</span> <span class="n">util</span>
<span class="n">c</span><span class="p">[</span><span class="s1">&#39;change_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">changes</span><span class="o">.</span><span class="n">SVNPoller</span><span class="p">(</span>
   <span class="n">repourl</span><span class="o">=</span><span class="s2">&quot;https://svn.amanda.sourceforge.net/svnroot/amanda/&quot;</span><span class="p">,</span>
   <span class="n">split_file</span><span class="o">=</span><span class="n">util</span><span class="o">.</span><span class="n">svn</span><span class="o">.</span><span class="n">split_file_projects_branches</span><span class="p">)</span>
</pre></div>
</div>
<p>Note here that we are monitoring at the root of the repository, and that within that repository is a <code class="docutils literal notranslate"><span class="pre">amanda</span></code> subdirectory which in turn has <code class="docutils literal notranslate"><span class="pre">trunk</span></code> and <code class="docutils literal notranslate"><span class="pre">branches</span></code>.
It is that <code class="docutils literal notranslate"><span class="pre">amanda</span></code> subdirectory whose name becomes the <code class="docutils literal notranslate"><span class="pre">project</span></code> field of the Change.</p>
</section>
<section id="branchname-project-filepath-repositories">
<h3><a class="toc-backref" href="#id23" role="doc-backlink"><span class="section-number">2.6.7.2. </span><code class="samp docutils literal notranslate"><em><span class="pre">BRANCHNAME</span></em><span class="pre">/</span><em><span class="pre">PROJECT</span></em><span class="pre">/</span><em><span class="pre">FILEPATH</span></em></code> repositories</a><a class="headerlink" href="#branchname-project-filepath-repositories" title="Link to this heading"></a></h3>
<p>Another common way to organize a Subversion repository is to put the branch name at the top, and the projects underneath.
This is especially frequent when there are a number of related sub-projects that all get released in a group.</p>
<p>For example, <code class="docutils literal notranslate"><span class="pre">Divmod.org</span></code> hosts a project named <cite>Nevow</cite> as well as one named <cite>Quotient</cite>.
In a checked-out Nevow tree there is a directory named <cite>formless</cite> that contains a Python source file named <code class="file docutils literal notranslate"><span class="pre">webform.py</span></code>.
This repository is accessible via webdav (and thus uses an <cite>http:</cite> scheme) through the divmod.org hostname.
There are many branches in this repository, and they use a <code class="docutils literal notranslate"><span class="pre">({BRANCHNAME})/({PROJECT})</span></code> naming policy.</p>
<p>The fully-qualified SVN URL for the trunk version of <code class="file docutils literal notranslate"><span class="pre">webform.py</span></code> is <code class="docutils literal notranslate"><span class="pre">http://divmod.org/svn/Divmod/trunk/Nevow/formless/webform.py</span></code>.
The 1.5.x branch version of this file would have a URL of <code class="docutils literal notranslate"><span class="pre">http://divmod.org/svn/Divmod/branches/1.5.x/Nevow/formless/webform.py</span></code>.
The whole Nevow trunk would be checked out with <code class="docutils literal notranslate"><span class="pre">http://divmod.org/svn/Divmod/trunk/Nevow</span></code>, while the Quotient trunk would be checked out using <code class="docutils literal notranslate"><span class="pre">http://divmod.org/svn/Divmod/trunk/Quotient</span></code>.</p>
<p>Now suppose we want to have an <a class="reference internal" href="configuration/changesources.html#chsrc-SVNPoller" title="SVNPoller"><code class="xref bb bb-chsrc docutils literal notranslate"><span class="pre">SVNPoller</span></code></a> that only cares about the Nevow trunk.
This case looks just like the <code class="samp docutils literal notranslate"><em><span class="pre">PROJECT</span></em><span class="pre">/</span><em><span class="pre">BRANCH</span></em></code> layout described earlier:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">buildbot.plugins</span> <span class="kn">import</span> <span class="n">changes</span>
<span class="n">c</span><span class="p">[</span><span class="s1">&#39;change_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">changes</span><span class="o">.</span><span class="n">SVNPoller</span><span class="p">(</span><span class="s2">&quot;http://divmod.org/svn/Divmod/trunk/Nevow&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>But what happens when we want to track multiple Nevow branches?
We have to point our <code class="docutils literal notranslate"><span class="pre">repourl=</span></code> high enough to see all those branches, but we also don’t want to include Quotient changes (since we’re only building Nevow).
To accomplish this, we must rely upon the <code class="docutils literal notranslate"><span class="pre">split_file</span></code> function to help us tell the difference between files that belong to Nevow and those that belong to Quotient, as well as figuring out which branch each one is on.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">buildbot.plugins</span> <span class="kn">import</span> <span class="n">changes</span>
<span class="n">c</span><span class="p">[</span><span class="s1">&#39;change_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">changes</span><span class="o">.</span><span class="n">SVNPoller</span><span class="p">(</span><span class="s2">&quot;http://divmod.org/svn/Divmod&quot;</span><span class="p">,</span>
                                       <span class="n">split_file</span><span class="o">=</span><span class="n">my_file_splitter</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">my_file_splitter</span></code> function will be called with repository-relative pathnames like:</p>
<dl class="simple">
<dt><code class="file docutils literal notranslate"><span class="pre">trunk/Nevow/formless/webform.py</span></code></dt><dd><p>This is a Nevow file, on the trunk.
We want the Change that includes this to see a filename of <code class="file docutils literal notranslate"><span class="pre">formless/webform.py</span></code>, and a branch of <code class="docutils literal notranslate"><span class="pre">None</span></code></p>
</dd>
<dt><code class="file docutils literal notranslate"><span class="pre">branches/1.5.x/Nevow/formless/webform.py</span></code></dt><dd><p>This is a Nevow file, on a branch.
We want to get <code class="docutils literal notranslate"><span class="pre">branch='branches/1.5.x'</span></code> and <code class="docutils literal notranslate"><span class="pre">filename='formless/webform.py'</span></code>.</p>
</dd>
<dt><code class="file docutils literal notranslate"><span class="pre">trunk/Quotient/setup.py</span></code></dt><dd><p>This is a Quotient file, so we want to ignore it by having <code class="xref py py-meth docutils literal notranslate"><span class="pre">my_file_splitter</span></code> return <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
</dd>
<dt><code class="file docutils literal notranslate"><span class="pre">branches/1.5.x/Quotient/setup.py</span></code></dt><dd><p>This is also a Quotient file, which should be ignored.</p>
</dd>
</dl>
<p>The following definition for <code class="xref py py-meth docutils literal notranslate"><span class="pre">my_file_splitter</span></code> will do the job:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">my_file_splitter</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">pieces</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pieces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;trunk&#39;</span><span class="p">:</span>
        <span class="n">branch</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">pieces</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># remove &#39;trunk&#39;</span>
    <span class="k">elif</span> <span class="n">pieces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;branches&#39;</span><span class="p">:</span>
        <span class="n">pieces</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># remove &#39;branches&#39;</span>
        <span class="c1"># grab branch name</span>
        <span class="n">branch</span> <span class="o">=</span> <span class="s1">&#39;branches/&#39;</span> <span class="o">+</span> <span class="n">pieces</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span> <span class="c1"># something weird</span>
    <span class="n">projectname</span> <span class="o">=</span> <span class="n">pieces</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">projectname</span> <span class="o">!=</span> <span class="s1">&#39;Nevow&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span> <span class="c1"># wrong project</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;branch&quot;</span><span class="p">:</span> <span class="n">branch</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pieces</span><span class="p">)}</span>
</pre></div>
</div>
<p>If you later decide you want to get changes for Quotient as well you could replace the last 3 lines with simply:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">return</span> <span class="p">{</span><span class="s2">&quot;project&quot;</span><span class="p">:</span> <span class="n">projectname</span><span class="p">,</span> <span class="s2">&quot;branch&quot;</span><span class="p">:</span> <span class="n">branch</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pieces</span><span class="p">)}</span>
</pre></div>
</div>
</section>
</section>
<section id="writing-change-sources">
<span id="id7"></span><h2><a class="toc-backref" href="#id24" role="doc-backlink"><span class="section-number">2.6.8. </span>Writing Change Sources</a><a class="headerlink" href="#writing-change-sources" title="Link to this heading"></a></h2>
<p>For some version-control systems, making Buildbot aware of new changes can be a challenge.
If the pre-supplied classes in <a class="reference internal" href="configuration/changesources.html#change-sources"><span class="std std-ref">Change Sources and Changes</span></a> are not sufficient, then you will need to write your own.</p>
<p>There are three approaches, one of which is not even a change source.
The first option is to write a change source that exposes some service to which the version control system can “push” changes.
This can be more complicated, since it requires implementing a new service, but delivers changes to Buildbot immediately on commit.</p>
<p>The second option is often preferable to the first: implement a notification service in an external process (perhaps one that is started directly by the version control system, or by an email server) and delivers changes to Buildbot via <a class="reference internal" href="configuration/changesources.html#pbchangesource"><span class="std std-ref">PBChangeSource</span></a>.
This section does not describe this particular approach, since it requires no customization within the buildmaster process.</p>
<p>The third option is to write a change source which polls for changes - repeatedly connecting to an external service to check for new changes.
This works well in many cases, but can produce a high load on the version control system if polling is too frequent, and can take too long to notice changes if the polling is not frequent enough.</p>
<section id="writing-a-notification-based-change-source">
<h3><a class="toc-backref" href="#id25" role="doc-backlink"><span class="section-number">2.6.8.1. </span>Writing a Notification-based Change Source</a><a class="headerlink" href="#writing-a-notification-based-change-source" title="Link to this heading"></a></h3>
<p>A custom change source must implement <code class="xref py py-class docutils literal notranslate"><span class="pre">buildbot.interfaces.IChangeSource</span></code>.</p>
<p>The easiest way to do this is to subclass <a class="reference internal" href="../developer/cls-changesources.html#buildbot.changes.base.ChangeSource" title="buildbot.changes.base.ChangeSource"><code class="xref py py-class docutils literal notranslate"><span class="pre">buildbot.changes.base.ChangeSource</span></code></a>, implementing the <code class="xref py py-meth docutils literal notranslate"><span class="pre">describe</span></code> method to describe the instance.
<code class="xref py py-class docutils literal notranslate"><span class="pre">ChangeSource</span></code> is a Twisted service, so you will need to implement the <code class="xref py py-meth docutils literal notranslate"><span class="pre">startService</span></code> and <code class="xref py py-meth docutils literal notranslate"><span class="pre">stopService</span></code> methods to control the means by which your change source receives notifications.</p>
<p>When the class does receive a change, it should call <code class="docutils literal notranslate"><span class="pre">self.master.data.updates.addChange(..)</span></code> to submit it to the buildmaster.
This method shares the same parameters as <code class="docutils literal notranslate"><span class="pre">master.db.changes.addChange</span></code>, so consult the API documentation for that function for details on the available arguments.</p>
<p>You will probably also want to set <code class="docutils literal notranslate"><span class="pre">compare_attrs</span></code> to the list of object attributes which Buildbot will use to compare one change source to another when reconfiguring.
During reconfiguration, if the new change source is different from the old, then the old will be stopped and the new started.</p>
</section>
<section id="writing-a-change-poller">
<h3><a class="toc-backref" href="#id26" role="doc-backlink"><span class="section-number">2.6.8.2. </span>Writing a Change Poller</a><a class="headerlink" href="#writing-a-change-poller" title="Link to this heading"></a></h3>
<p>Polling is a very common means of seeking changes, so Buildbot supplies a utility parent class to make it easier.
A poller should subclass <a class="reference internal" href="../developer/cls-changesources.html#buildbot.changes.base.ReconfigurablePollingChangeSource" title="buildbot.changes.base.ReconfigurablePollingChangeSource"><code class="xref py py-class docutils literal notranslate"><span class="pre">buildbot.changes.base.ReconfigurablePollingChangeSource</span></code></a>, which is a subclass of <a class="reference internal" href="../developer/cls-changesources.html#buildbot.changes.base.ChangeSource" title="buildbot.changes.base.ChangeSource"><code class="xref py py-class docutils literal notranslate"><span class="pre">ChangeSource</span></code></a>.
This subclass implements the <code class="xref py py-meth docutils literal notranslate"><span class="pre">Service</span></code> methods, and calls the <code class="xref py py-meth docutils literal notranslate"><span class="pre">poll</span></code> method according to the <code class="docutils literal notranslate"><span class="pre">pollInterval</span></code> and <code class="docutils literal notranslate"><span class="pre">pollAtLaunch</span></code> options.
The <code class="docutils literal notranslate"><span class="pre">poll</span></code> method should return a Deferred to signal its completion.</p>
<p>Aside from the service methods, the other concerns in the previous section apply here, too.</p>
</section>
</section>
<section id="writing-a-new-latent-worker-implementation">
<h2><a class="toc-backref" href="#id27" role="doc-backlink"><span class="section-number">2.6.9. </span>Writing a New Latent Worker Implementation</a><a class="headerlink" href="#writing-a-new-latent-worker-implementation" title="Link to this heading"></a></h2>
<p>Writing a new latent worker should only require subclassing <a class="reference internal" href="#buildbot.worker.AbstractLatentWorker" title="buildbot.worker.AbstractLatentWorker"><code class="xref py py-class docutils literal notranslate"><span class="pre">buildbot.worker.AbstractLatentWorker</span></code></a> and implementing <a class="reference internal" href="#start_instance" title="start_instance"><code class="xref py py-meth docutils literal notranslate"><span class="pre">start_instance</span></code></a> and <a class="reference internal" href="#stop_instance" title="stop_instance"><code class="xref py py-meth docutils literal notranslate"><span class="pre">stop_instance</span></code></a> at a minimum.</p>
<section id="abstractlatentworker">
<span id="worker-AbstractWorkerController"></span><h3><a class="toc-backref" href="#id28" role="doc-backlink"><span class="section-number">2.6.9.1. </span>AbstractLatentWorker</a><a class="headerlink" href="#abstractlatentworker" title="Link to this heading"></a></h3>
<dl class="py class">
<dt class="sig sig-object py" id="buildbot.worker.AbstractLatentWorker">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">buildbot.worker.</span></span><span class="sig-name descname"><span class="pre">AbstractLatentWorker</span></span><a class="headerlink" href="#buildbot.worker.AbstractLatentWorker" title="Link to this definition"></a></dt>
<dd></dd></dl>

<p>This class is the base class of all latent workers and implements some common functionality.
A custom worker should only need to override <a class="reference internal" href="#start_instance" title="start_instance"><code class="xref py py-meth docutils literal notranslate"><span class="pre">start_instance</span></code></a> and <a class="reference internal" href="#stop_instance" title="stop_instance"><code class="xref py py-meth docutils literal notranslate"><span class="pre">stop_instance</span></code></a> methods.</p>
<p>See <a class="reference internal" href="configuration/workers-ec2.html#buildbot.worker.ec2.EC2LatentWorker" title="buildbot.worker.ec2.EC2LatentWorker"><code class="xref py py-class docutils literal notranslate"><span class="pre">buildbot.worker.ec2.EC2LatentWorker</span></code></a> for an example.</p>
<p>Additionally, <a class="reference internal" href="#builds_may_be_incompatible" title="builds_may_be_incompatible"><code class="xref py py-meth docutils literal notranslate"><span class="pre">builds_may_be_incompatible</span></code></a> and <a class="reference internal" href="#isCompatibleWithBuild" title="isCompatibleWithBuild"><code class="xref py py-attr docutils literal notranslate"><span class="pre">isCompatibleWithBuild</span></code></a> members must be overridden if some qualities of the new instances is determined dynamically according to the properties of an incoming build.
An example a build may require a certain Docker image or amount of allocated memory.
Overriding these members ensures that builds aren’t ran on incompatible workers that have already been started.</p>
<blockquote>
<div><dl class="py method">
<dt class="sig sig-object py" id="start_instance">
<span class="sig-name descname"><span class="pre">start_instance</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#start_instance" title="Link to this definition"></a></dt>
<dd><p>This method is responsible for starting instance that will try to connect with this master.
A deferred should be returned.</p>
<p>Any problems should use an errback or exception.
When the error is likely related to infrastructure problem and the worker should be paused in case it produces too many errors, then <code class="docutils literal notranslate"><span class="pre">LatentWorkerFailedToSubstantiate</span></code> should be thrown.
When the error is related to the properties of the build request, such as renderable Docker image, then <code class="docutils literal notranslate"><span class="pre">LatentWorkerCannotSubstantiate</span></code> should be thrown.</p>
<p>The callback value can be <code class="docutils literal notranslate"><span class="pre">None</span></code>, or can be an iterable of short strings to include in the “substantiate success” status message, such as identifying the instance that started.
Buildbot will ensure that a single worker will never have its <code class="docutils literal notranslate"><span class="pre">start_instance</span></code> called before any previous calls to <code class="docutils literal notranslate"><span class="pre">start_instance</span></code> or <code class="docutils literal notranslate"><span class="pre">stop_instance</span></code> finish.
Additionally, for each <code class="docutils literal notranslate"><span class="pre">start_instance</span></code> call, exactly one corresponding call to <code class="docutils literal notranslate"><span class="pre">stop_instance</span></code> will be done eventually.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="stop_instance">
<span class="sig-name descname"><span class="pre">stop_instance</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">fast</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#stop_instance" title="Link to this definition"></a></dt>
<dd><p>This method is responsible for shutting down instance.
A deferred should be returned.
If <code class="docutils literal notranslate"><span class="pre">fast</span></code> is <code class="docutils literal notranslate"><span class="pre">True</span></code> then the function should call back as soon as it is safe to do so, as, for example, the master may be shutting down.
The value returned by the callback is ignored.
Buildbot will ensure that a single worker will never have its <code class="docutils literal notranslate"><span class="pre">stop_instance</span></code> called before any previous calls to <code class="docutils literal notranslate"><span class="pre">stop_instance</span></code> finish.
During master shutdown any pending calls to <code class="docutils literal notranslate"><span class="pre">start_instance</span></code> or <code class="docutils literal notranslate"><span class="pre">stop_instance</span></code> will be waited upon finish.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="builds_may_be_incompatible">
<span class="sig-name descname"><span class="pre">builds_may_be_incompatible</span></span><a class="headerlink" href="#builds_may_be_incompatible" title="Link to this definition"></a></dt>
<dd><p>Determines if new instances have qualities dependent on the build.
If <code class="docutils literal notranslate"><span class="pre">True</span></code>, the master will call <code class="docutils literal notranslate"><span class="pre">isCompatibleWithBuild</span></code> to determine whether new builds are compatible with the started instance.
Unnecessarily setting <code class="docutils literal notranslate"><span class="pre">builds_may_be_incompatible</span></code> to <code class="docutils literal notranslate"><span class="pre">True</span></code> may result in unnecessary overhead when processing the builds.
By default, this is <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="isCompatibleWithBuild">
<span class="sig-name descname"><span class="pre">isCompatibleWithBuild</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">build_props</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#isCompatibleWithBuild" title="Link to this definition"></a></dt>
<dd><p>This method determines whether a started instance is compatible with the build that is about to be started.
<code class="docutils literal notranslate"><span class="pre">build_props</span></code> is the properties of the build that are known before the build has been started.
A build may be incompatible with already started instance if, for example, it requests a different amount of memory or a different Docker image.
A deferred should be returned, whose callback should return <code class="docutils literal notranslate"><span class="pre">True</span></code> if build is compatible and <code class="docutils literal notranslate"><span class="pre">False</span></code> otherwise.
The method may be called when the instance is not yet started and should indicate compatible build in that case.
In the default implementation the callback returns <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="check_instance">
<span class="sig-name descname"><span class="pre">check_instance</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#check_instance" title="Link to this definition"></a></dt>
<dd><p>This method determines the health of an instance.
The method is expected to return a tuple with two members: <code class="docutils literal notranslate"><span class="pre">is_good</span></code> and <code class="docutils literal notranslate"><span class="pre">message</span></code>.
The first member identifies whether the instance is still valid.
It should be <code class="docutils literal notranslate"><span class="pre">False</span></code> if the method determined that a serious error has occurred and worker will not connect to the master.
In such case, <code class="docutils literal notranslate"><span class="pre">message</span></code> should identify any additional error message that should be displayed to Buildbot user.</p>
<p>In case there is no additional messages, <code class="docutils literal notranslate"><span class="pre">message</span></code> should be an empty string.</p>
<p>Any exceptions raised from this method are interpreted as if the method returned <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p>
</dd></dl>

</div></blockquote>
</section>
</section>
<section id="custom-build-classes">
<h2><a class="toc-backref" href="#id29" role="doc-backlink"><span class="section-number">2.6.10. </span>Custom Build Classes</a><a class="headerlink" href="#custom-build-classes" title="Link to this heading"></a></h2>
<p>The standard <code class="xref py py-class docutils literal notranslate"><span class="pre">BuildFactory</span></code> object creates <code class="xref py py-class docutils literal notranslate"><span class="pre">Build</span></code> objects by default.
These Builds will each execute a collection of <code class="xref py py-class docutils literal notranslate"><span class="pre">BuildStep</span></code>s in a fixed sequence.
Each step can affect the results of the build, but in general there is little intelligence to tie the different steps together.</p>
<p>By setting the factory’s <code class="docutils literal notranslate"><span class="pre">buildClass</span></code> attribute to a different class, you can instantiate a different build class.
This might be useful, for example, to create a build class that dynamically determines which steps to run.
The skeleton of such a project would look like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DynamicBuild</span><span class="p">(</span><span class="n">Build</span><span class="p">):</span>
    <span class="c1"># override some methods</span>
    <span class="o">...</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">BuildFactory</span><span class="p">()</span>
<span class="n">f</span><span class="o">.</span><span class="n">buildClass</span> <span class="o">=</span> <span class="n">DynamicBuild</span>
<span class="n">f</span><span class="o">.</span><span class="n">addStep</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="factory-workdir-functions">
<span id="id8"></span><h2><a class="toc-backref" href="#id30" role="doc-backlink"><span class="section-number">2.6.11. </span>Factory Workdir Functions</a><a class="headerlink" href="#factory-workdir-functions" title="Link to this heading"></a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>While the factory workdir function is still supported, it is better to just use the fact that workdir is a <span class="target" id="index-4"></span>renderable attribute of a step.
A Renderable has access to much more contextual information and can also return a deferred.
So you could say <code class="docutils literal notranslate"><span class="pre">build_factory.workdir</span> <span class="pre">=</span> <span class="pre">util.Interpolate(&quot;%(src:repository)s</span></code> to achieve similar goal.</p>
</div>
<p>It is sometimes helpful to have a build’s workdir determined at runtime based on the parameters of the build.
To accomplish this, set the <code class="docutils literal notranslate"><span class="pre">workdir</span></code> attribute of the build factory to a callable.
That callable will be invoked with the list of <code class="xref py py-class docutils literal notranslate"><span class="pre">SourceStamp</span></code> for the build, and should return the appropriate workdir.
Note that the value must be returned immediately - Deferreds are not supported.</p>
<p>This can be useful, for example, in scenarios with multiple repositories submitting changes to Buildbot.
In this case you likely will want to have a dedicated workdir per repository, since otherwise a sourcing step with mode = “update” will fail as a workdir with a working copy of repository A can’t be “updated” for changes from a repository B.
Here is an example how you can achieve workdir-per-repo:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">workdir</span><span class="p">(</span><span class="n">source_stamps</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">source_stamps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">repository</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">8</span><span class="p">]</span>

<span class="n">build_factory</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">BuildFactory</span><span class="p">()</span>
<span class="n">build_factory</span><span class="o">.</span><span class="n">workdir</span> <span class="o">=</span> <span class="n">workdir</span>

<span class="n">build_factory</span><span class="o">.</span><span class="n">addStep</span><span class="p">(</span><span class="n">Git</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;update&quot;</span><span class="p">))</span>
<span class="c1"># ...</span>
<span class="n">builders</span><span class="o">.</span><span class="n">append</span> <span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;mybuilder&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;workername&#39;</span><span class="p">:</span> <span class="s1">&#39;myworker&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;builddir&#39;</span><span class="p">:</span> <span class="s1">&#39;mybuilder&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;factory&#39;</span><span class="p">:</span> <span class="n">build_factory</span><span class="p">})</span>
</pre></div>
</div>
<p>The end result is a set of workdirs like</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Repo1 =&gt; &lt;worker-base&gt;/mybuilder/a78890ba
Repo2 =&gt; &lt;worker-base&gt;/mybuilder/0823ba88
</pre></div>
</div>
<p>You could make the <code class="xref py py-func docutils literal notranslate"><span class="pre">workdir</span></code> function compute other paths, based on parts of the repo URL in the sourcestamp, or lookup in a lookup table based on repo URL.
As long as there is a permanent 1:1 mapping between repos and workdir, this will work.</p>
</section>
<section id="writing-new-buildsteps">
<span id="id9"></span><h2><a class="toc-backref" href="#id31" role="doc-backlink"><span class="section-number">2.6.12. </span>Writing New BuildSteps</a><a class="headerlink" href="#writing-new-buildsteps" title="Link to this heading"></a></h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The API of writing custom build steps has changed significantly in Buildbot-0.9.0.
See <a class="reference internal" href="upgrading/0.9-new-style-steps.html#new-style-build-steps"><span class="std std-ref">New-Style Build Steps in Buildbot 0.9.0</span></a> for details about what has changed since pre 0.9.0 releases.
This section documents new-style steps.</p>
</div>
<p>While it is a good idea to keep your build process self-contained in the source code tree, sometimes it is convenient to put more intelligence into your Buildbot configuration.
One way to do this is to write a custom <a class="reference internal" href="../developer/cls-buildsteps.html#buildbot.process.buildstep.BuildStep" title="buildbot.process.buildstep.BuildStep"><code class="xref py py-class docutils literal notranslate"><span class="pre">BuildStep</span></code></a>.
Once written, this Step can be used in the <code class="file docutils literal notranslate"><span class="pre">master.cfg</span></code> file.</p>
<p>The best reason for writing a custom <code class="xref py py-class docutils literal notranslate"><span class="pre">BuildStep</span></code> is to better parse the results of the command being run.
For example, a <a class="reference internal" href="../developer/cls-buildsteps.html#buildbot.process.buildstep.BuildStep" title="buildbot.process.buildstep.BuildStep"><code class="xref py py-class docutils literal notranslate"><span class="pre">BuildStep</span></code></a> that knows about JUnit could look at the logfiles to determine which tests had been run, how many passed and how many failed, and then report more detailed information than a simple <code class="docutils literal notranslate"><span class="pre">rc==0</span></code> -based <cite>good/bad</cite> decision.</p>
<p>Buildbot has acquired a large fleet of build steps, and sports a number of knobs and hooks to make steps easier to write.
This section may seem a bit overwhelming, but most custom steps will only need to apply one or two of the techniques outlined here.</p>
<p>For complete documentation of the build step interfaces, see <a class="reference internal" href="../developer/cls-buildsteps.html"><span class="doc">BuildSteps</span></a>.</p>
<section id="writing-buildstep-constructors">
<span id="id10"></span><h3><a class="toc-backref" href="#id32" role="doc-backlink"><span class="section-number">2.6.12.1. </span>Writing BuildStep Constructors</a><a class="headerlink" href="#writing-buildstep-constructors" title="Link to this heading"></a></h3>
<p>Build steps act as their own factories, so their constructors are a bit more complex than necessary.
The configuration file instantiates a <a class="reference internal" href="../developer/cls-buildsteps.html#buildbot.process.buildstep.BuildStep" title="buildbot.process.buildstep.BuildStep"><code class="xref py py-class docutils literal notranslate"><span class="pre">BuildStep</span></code></a> object, but the step configuration must be re-used for multiple builds, so Buildbot needs some way to create more steps.</p>
<p>Consider the use of a <code class="xref py py-class docutils literal notranslate"><span class="pre">BuildStep</span></code> in <code class="file docutils literal notranslate"><span class="pre">master.cfg</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="o">.</span><span class="n">addStep</span><span class="p">(</span><span class="n">MyStep</span><span class="p">(</span><span class="n">someopt</span><span class="o">=</span><span class="s2">&quot;stuff&quot;</span><span class="p">,</span> <span class="n">anotheropt</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
<p>This creates a single instance of class <code class="docutils literal notranslate"><span class="pre">MyStep</span></code>.
However, Buildbot needs a new object each time the step is executed.
An instance of <a class="reference internal" href="../developer/cls-buildsteps.html#buildbot.process.buildstep.BuildStep" title="buildbot.process.buildstep.BuildStep"><code class="xref py py-class docutils literal notranslate"><span class="pre">BuildStep</span></code></a> remembers how it was constructed, and can create copies of itself.
When writing a new step class, then, keep in mind that you cannot do anything “interesting” in the constructor – limit yourself to checking and storing arguments.</p>
<p>It is customary to call the parent class’s constructor with all otherwise-unspecified keyword arguments.
Keep a <code class="docutils literal notranslate"><span class="pre">**kwargs</span></code> argument on the end of your options, and pass that up to the parent class’s constructor.</p>
<p>The whole thing looks like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Frobnify</span><span class="p">(</span><span class="n">BuildStep</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">frob_what</span><span class="o">=</span><span class="s2">&quot;frobee&quot;</span><span class="p">,</span>
            <span class="n">frob_how_many</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">frob_how</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># check</span>
        <span class="k">if</span> <span class="n">frob_how_many</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Frobnify argument how_many is required&quot;</span><span class="p">)</span>

        <span class="c1"># override a parent option</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;parentOpt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;xyz&#39;</span>

        <span class="c1"># call parent</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># set Frobnify attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frob_what</span> <span class="o">=</span> <span class="n">frob_what</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frob_how_many</span> <span class="o">=</span> <span class="n">how_many</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frob_how</span> <span class="o">=</span> <span class="n">frob_how</span>

<span class="k">class</span> <span class="nc">FastFrobnify</span><span class="p">(</span><span class="n">Frobnify</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">speed</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">speed</span>
</pre></div>
</div>
</section>
<section id="step-execution-process">
<h3><a class="toc-backref" href="#id33" role="doc-backlink"><span class="section-number">2.6.12.2. </span>Step Execution Process</a><a class="headerlink" href="#step-execution-process" title="Link to this heading"></a></h3>
<p>A step’s execution occurs in its <a class="reference internal" href="../developer/cls-buildsteps.html#buildbot.process.buildstep.BuildStep.run" title="buildbot.process.buildstep.BuildStep.run"><code class="xref py py-meth docutils literal notranslate"><span class="pre">run</span></code></a> method.
When this method returns (more accurately, when the Deferred it returns fires), the step is complete.
The method’s result must be an integer, giving the result of the step.
Any other output from the step (logfiles, status strings, URLs, etc.) is the responsibility of the <code class="docutils literal notranslate"><span class="pre">run</span></code> method.</p>
<p>The <a class="reference internal" href="configuration/steps/shell_command.html#step-ShellCommand" title="ShellCommand"><code class="xref bb bb-step docutils literal notranslate"><span class="pre">ShellCommand</span></code></a> class implements this <code class="docutils literal notranslate"><span class="pre">run</span></code> method, and in most cases steps subclassing <code class="docutils literal notranslate"><span class="pre">ShellCommand</span></code> simply implement some of the subsidiary methods that its <code class="docutils literal notranslate"><span class="pre">run</span></code> method calls.</p>
</section>
<section id="running-commands">
<h3><a class="toc-backref" href="#id34" role="doc-backlink"><span class="section-number">2.6.12.3. </span>Running Commands</a><a class="headerlink" href="#running-commands" title="Link to this heading"></a></h3>
<p>To spawn a command in the worker, create a <a class="reference internal" href="../developer/cls-remotecommands.html#buildbot.process.remotecommand.RemoteCommand" title="buildbot.process.remotecommand.RemoteCommand"><code class="xref py py-class docutils literal notranslate"><span class="pre">RemoteCommand</span></code></a> instance in your step’s <code class="docutils literal notranslate"><span class="pre">run</span></code> method and run it with <code class="xref py py-meth docutils literal notranslate"><span class="pre">runCommand</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cmd</span> <span class="o">=</span> <span class="n">RemoteCommand</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runCommand</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="xref py py-class docutils literal notranslate"><span class="pre">CommandMixin</span></code> class offers a simple interface to several common worker-side commands.</p>
<p>For the much more common task of running a shell command on the worker, use <code class="xref py py-class docutils literal notranslate"><span class="pre">ShellMixin</span></code>.
This class provides a method to handle the myriad constructor arguments related to shell commands, as well as a method to create new <a class="reference internal" href="../developer/cls-remotecommands.html#buildbot.process.remotecommand.RemoteCommand" title="buildbot.process.remotecommand.RemoteCommand"><code class="xref py py-class docutils literal notranslate"><span class="pre">RemoteCommand</span></code></a> instances.
This mixin is the recommended method of implementing custom shell-based steps.
For simple steps that don’t involve much logic the <cite>:bb:step:`ShellCommand</cite> is recommended.</p>
<p>A simple example of a step using the shell mixin is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">RunCleanup</span><span class="p">(</span><span class="n">buildstep</span><span class="o">.</span><span class="n">ShellMixin</span><span class="p">,</span> <span class="n">buildstep</span><span class="o">.</span><span class="n">BuildStep</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cleanupScript</span><span class="o">=</span><span class="s1">&#39;./cleanup.sh&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanupScript</span> <span class="o">=</span> <span class="n">cleanupScript</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setupShellMixin</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">prohibitArgs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;command&#39;</span><span class="p">])</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@defer</span><span class="o">.</span><span class="n">inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">makeRemoteShellCommand</span><span class="p">(</span>
                <span class="n">command</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cleanupScript</span><span class="p">])</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">runCommand</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cmd</span><span class="o">.</span><span class="n">didFail</span><span class="p">():</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">makeRemoteShellCommand</span><span class="p">(</span>
                    <span class="n">command</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cleanupScript</span><span class="p">,</span> <span class="s1">&#39;--force&#39;</span><span class="p">],</span>
                    <span class="n">logEnviron</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">runCommand</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cmd</span><span class="o">.</span><span class="n">results</span><span class="p">()</span>

<span class="nd">@defer</span><span class="o">.</span><span class="n">inlineCallbacks</span>
<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">RemoteCommand</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">log</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">addLog</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">)</span>
    <span class="n">cmd</span><span class="o">.</span><span class="n">useLog</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="n">closeWhenFinished</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">runCommand</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="updating-status-strings">
<h3><a class="toc-backref" href="#id35" role="doc-backlink"><span class="section-number">2.6.12.4. </span>Updating Status Strings</a><a class="headerlink" href="#updating-status-strings" title="Link to this heading"></a></h3>
<p>Each step can summarize its current status in a very short string.
For example, a compile step might display the file being compiled.
This information can be helpful to users eager to see their build finish.</p>
<p>Similarly, a build has a set of short strings collected from its steps summarizing the overall state of the build.
Useful information here might include the number of tests run, but probably not the results of a <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">clean</span></code> step.</p>
<p>As a step runs, Buildbot calls its <a class="reference internal" href="../developer/cls-buildsteps.html#buildbot.process.buildstep.BuildStep.getCurrentSummary" title="buildbot.process.buildstep.BuildStep.getCurrentSummary"><code class="xref py py-meth docutils literal notranslate"><span class="pre">getCurrentSummary</span></code></a> method as necessary to get the step’s current status.
“As necessary” is determined by calls to <a class="reference internal" href="../developer/cls-buildsteps.html#buildbot.process.buildstep.BuildStep.updateSummary" title="buildbot.process.buildstep.BuildStep.updateSummary"><code class="xref py py-meth docutils literal notranslate"><span class="pre">buildbot.process.buildstep.BuildStep.updateSummary</span></code></a>.
Your step should call this method every time the status summary may have changed.
Buildbot will take care of rate-limiting summary updates.</p>
<p>When the step is complete, Buildbot calls its <a class="reference internal" href="../developer/cls-buildsteps.html#buildbot.process.buildstep.BuildStep.getResultSummary" title="buildbot.process.buildstep.BuildStep.getResultSummary"><code class="xref py py-meth docutils literal notranslate"><span class="pre">getResultSummary</span></code></a> method to get a final summary of the step along with a summary for the build.</p>
</section>
<section id="about-logfiles">
<h3><a class="toc-backref" href="#id36" role="doc-backlink"><span class="section-number">2.6.12.5. </span>About Logfiles</a><a class="headerlink" href="#about-logfiles" title="Link to this heading"></a></h3>
<p>Each BuildStep has a collection of log files.
Each one has a short name, like <cite>stdio</cite> or <cite>warnings</cite>.
Each log file contains an arbitrary amount of text, usually the contents of some output file generated during a build or test step, or a record of everything that was printed to <code class="file docutils literal notranslate"><span class="pre">stdout</span></code>/<code class="file docutils literal notranslate"><span class="pre">stderr</span></code> during the execution of some command.</p>
<p>Each can contain multiple <cite>channels</cite>, generally limited to three basic ones: stdout, stderr, and <cite>headers</cite>.
For example, when a shell command runs, it writes a few lines to the headers channel to indicate the exact argv strings being run, which directory the command is being executed in, and the contents of the current environment variables.
Then, as the command runs, it adds a lot of <code class="file docutils literal notranslate"><span class="pre">stdout</span></code> and <code class="file docutils literal notranslate"><span class="pre">stderr</span></code> messages.
When the command finishes, a final <cite>header</cite> line is added with the exit code of the process.</p>
<p>Status display plugins can format these different channels in different ways.
For example, the web page shows log files as text/html, with header lines in blue text, stdout in black, and stderr in red.
A different URL is available which provides a text/plain format, in which stdout and stderr are collapsed together, and header lines are stripped completely.
This latter option makes it easy to save the results to a file and run <strong class="command">grep</strong> or whatever against the output.</p>
</section>
<section id="writing-log-files">
<h3><a class="toc-backref" href="#id37" role="doc-backlink"><span class="section-number">2.6.12.6. </span>Writing Log Files</a><a class="headerlink" href="#writing-log-files" title="Link to this heading"></a></h3>
<p>Most commonly, logfiles come from commands run on the worker.
Internally, these are configured by supplying the <a class="reference internal" href="../developer/cls-remotecommands.html#buildbot.process.remotecommand.RemoteCommand" title="buildbot.process.remotecommand.RemoteCommand"><code class="xref py py-class docutils literal notranslate"><span class="pre">RemoteCommand</span></code></a> instance with log files via the <code class="xref py py-meth docutils literal notranslate"><span class="pre">useLog</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@defer</span><span class="o">.</span><span class="n">inlineCallbacks</span>
<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">log</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">addLog</span><span class="p">(</span><span class="s1">&#39;stdio&#39;</span><span class="p">)</span>
    <span class="n">cmd</span><span class="o">.</span><span class="n">useLog</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="n">closeWhenFinished</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;stdio&#39;</span><span class="p">)</span>
    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">runCommand</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
</pre></div>
</div>
<p>The name passed to <code class="xref py py-meth docutils literal notranslate"><span class="pre">useLog</span></code> must match that configured in the command.
In this case, <code class="docutils literal notranslate"><span class="pre">stdio</span></code> is the default.</p>
<p>If the log file was already added by another part of the step, it can be retrieved with <a class="reference internal" href="../developer/cls-buildsteps.html#buildbot.process.buildstep.BuildStep.getLog" title="buildbot.process.buildstep.BuildStep.getLog"><code class="xref py py-meth docutils literal notranslate"><span class="pre">getLog</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">stdioLog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getLog</span><span class="p">(</span><span class="s1">&#39;stdio&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Less frequently, some master-side processing produces a log file.
If this log file is short and easily stored in memory, this is as simple as a call to <a class="reference internal" href="../developer/cls-buildsteps.html#buildbot.process.buildstep.BuildStep.addCompleteLog" title="buildbot.process.buildstep.BuildStep.addCompleteLog"><code class="xref py py-meth docutils literal notranslate"><span class="pre">addCompleteLog</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@defer</span><span class="o">.</span><span class="n">inlineCallbacks</span>
<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
                         <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lint_results</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">addCompleteLog</span><span class="p">(</span><span class="s1">&#39;summary&#39;</span><span class="p">,</span> <span class="n">summary</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that the log contents must be a unicode string.</p>
<p>Longer logfiles can be constructed line-by-line using the <code class="docutils literal notranslate"><span class="pre">add</span></code> methods of the log file:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@defer</span><span class="o">.</span><span class="n">inlineCallbacks</span>
<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">updates</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">addLog</span><span class="p">(</span><span class="s1">&#39;updates&#39;</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="o">...</span>
        <span class="k">yield</span> <span class="n">updates</span><span class="o">.</span><span class="n">addStdout</span><span class="p">(</span><span class="n">some_update</span><span class="p">)</span>
</pre></div>
</div>
<p>Again, note that the log input must be a unicode string.</p>
<p>Finally, <a class="reference internal" href="../developer/cls-buildsteps.html#buildbot.process.buildstep.BuildStep.addHTMLLog" title="buildbot.process.buildstep.BuildStep.addHTMLLog"><code class="xref py py-meth docutils literal notranslate"><span class="pre">addHTMLLog</span></code></a> is similar to <a class="reference internal" href="../developer/cls-buildsteps.html#buildbot.process.buildstep.BuildStep.addCompleteLog" title="buildbot.process.buildstep.BuildStep.addCompleteLog"><code class="xref py py-meth docutils literal notranslate"><span class="pre">addCompleteLog</span></code></a>, but the resulting log will be tagged as containing HTML.
The web UI will display the contents of the log using the browser.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">logfiles=</span></code> argument to <a class="reference internal" href="configuration/steps/shell_command.html#step-ShellCommand" title="ShellCommand"><code class="xref bb bb-step docutils literal notranslate"><span class="pre">ShellCommand</span></code></a> and its subclasses creates new log files and fills them in realtime by asking the worker to watch an actual file on disk.
The worker will look for additions in the target file and report them back to the <code class="xref py py-class docutils literal notranslate"><span class="pre">BuildStep</span></code>.
These additions will be added to the log file by calling <code class="xref py py-meth docutils literal notranslate"><span class="pre">addStdout</span></code>.</p>
<p>All log files can be used as the source of a <a class="reference internal" href="../developer/cls-logobserver.html#buildbot.process.logobserver.LogObserver" title="buildbot.process.logobserver.LogObserver"><code class="xref py py-class docutils literal notranslate"><span class="pre">LogObserver</span></code></a> just like the normal <code class="file docutils literal notranslate"><span class="pre">stdio</span></code> <code class="xref py py-class docutils literal notranslate"><span class="pre">LogFile</span></code>.
In fact, it’s possible for one <a class="reference internal" href="../developer/cls-logobserver.html#buildbot.process.logobserver.LogObserver" title="buildbot.process.logobserver.LogObserver"><code class="xref py py-class docutils literal notranslate"><span class="pre">LogObserver</span></code></a> to observe a logfile created by another.</p>
</section>
<section id="reading-logfiles">
<h3><a class="toc-backref" href="#id38" role="doc-backlink"><span class="section-number">2.6.12.7. </span>Reading Logfiles</a><a class="headerlink" href="#reading-logfiles" title="Link to this heading"></a></h3>
<p>For the most part, Buildbot tries to avoid loading the contents of a log file into memory as a single string.
For large log files on a busy master, this behavior can quickly consume a great deal of memory.</p>
<p>Instead, steps should implement a <a class="reference internal" href="../developer/cls-logobserver.html#buildbot.process.logobserver.LogObserver" title="buildbot.process.logobserver.LogObserver"><code class="xref py py-class docutils literal notranslate"><span class="pre">LogObserver</span></code></a> to examine log files one chunk or line at a time.</p>
<p>For commands which only produce a small quantity of output, <a class="reference internal" href="../developer/cls-remotecommands.html#buildbot.process.remotecommand.RemoteCommand" title="buildbot.process.remotecommand.RemoteCommand"><code class="xref py py-class docutils literal notranslate"><span class="pre">RemoteCommand</span></code></a> will collect the command’s stdout into its <a class="reference internal" href="../developer/cls-remotecommands.html#buildbot.process.remotecommand.RemoteCommand.stdout" title="buildbot.process.remotecommand.RemoteCommand.stdout"><code class="xref py py-attr docutils literal notranslate"><span class="pre">stdout</span></code></a> attribute if given the <code class="docutils literal notranslate"><span class="pre">collectStdout=True</span></code> constructor argument.</p>
</section>
<section id="adding-logobservers">
<span id="id11"></span><h3><a class="toc-backref" href="#id39" role="doc-backlink"><span class="section-number">2.6.12.8. </span>Adding LogObservers</a><a class="headerlink" href="#adding-logobservers" title="Link to this heading"></a></h3>
<p>Most shell commands emit messages to stdout or stderr as they operate, especially if you ask them nicely with a option <cite>–verbose</cite> flag of some sort.
They may also write text to a log file while they run.
Your <code class="xref py py-class docutils literal notranslate"><span class="pre">BuildStep</span></code> can watch this output as it arrives, to keep track of how much progress the command has made or to process log output for later summarization.</p>
<p>To accomplish this, you will need to attach a <a class="reference internal" href="../developer/cls-logobserver.html#buildbot.process.logobserver.LogObserver" title="buildbot.process.logobserver.LogObserver"><code class="xref py py-class docutils literal notranslate"><span class="pre">LogObserver</span></code></a> to the log.
This observer is given all text as it is emitted from the command, and has the opportunity to parse that output incrementally.</p>
<p>There are a number of pre-built <a class="reference internal" href="../developer/cls-logobserver.html#buildbot.process.logobserver.LogObserver" title="buildbot.process.logobserver.LogObserver"><code class="xref py py-class docutils literal notranslate"><span class="pre">LogObserver</span></code></a> classes that you can choose from (defined in <a class="reference internal" href="../developer/cls-buildsteps.html#module-buildbot.process.buildstep" title="buildbot.process.buildstep"><code class="xref py py-mod docutils literal notranslate"><span class="pre">buildbot.process.buildstep</span></code></a>, and of course you can subclass them to add further customization.
The <code class="xref py py-class docutils literal notranslate"><span class="pre">LogLineObserver</span></code> class handles the grunt work of buffering and scanning for end-of-line delimiters, allowing your parser to operate on complete <code class="file docutils literal notranslate"><span class="pre">stdout</span></code>/<code class="file docutils literal notranslate"><span class="pre">stderr</span></code> lines.</p>
<p>For example, let’s take a look at the <code class="xref py py-class docutils literal notranslate"><span class="pre">TrialTestCaseCounter</span></code>, which is used by the <a class="reference internal" href="configuration/steps/trial.html#step-Trial" title="Trial"><code class="xref bb bb-step docutils literal notranslate"><span class="pre">Trial</span></code></a> step to count test cases as they are run.
As Trial executes, it emits lines like the following:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>buildbot.test.test_config.ConfigTest.testDebugPassword ... [OK]
buildbot.test.test_config.ConfigTest.testEmpty ... [OK]
buildbot.test.test_config.ConfigTest.testIRC ... [FAIL]
buildbot.test.test_config.ConfigTest.testLocks ... [OK]
</pre></div>
</div>
<p>When the tests are finished, trial emits a long line of <cite>======</cite> and then some lines which summarize the tests that failed.
We want to avoid parsing these trailing lines, because their format is less well-defined than the <cite>[OK]</cite> lines.</p>
<p>A simple version of the parser for this output looks like this.
The full version is in <a class="reference external" href="https://github.com/buildbot/buildbot/tree/master/master/buildbot/steps/python_twisted.py">master/buildbot/steps/python_twisted.py</a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">buildbot.plugins</span> <span class="kn">import</span> <span class="n">util</span>

<span class="k">class</span> <span class="nc">TrialTestCaseCounter</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">LogLineObserver</span><span class="p">):</span>
    <span class="n">_line_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^([\w\.]+) \.\.\. \[([^\]]+)\]$&#39;</span><span class="p">)</span>
    <span class="n">numTests</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">finished</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">outLineReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finished</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span>

        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_line_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">testname</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">numTests</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">setProgress</span><span class="p">(</span><span class="s1">&#39;tests&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numTests</span><span class="p">)</span>
</pre></div>
</div>
<p>This parser only pays attention to stdout, since that’s where trial writes the progress lines.
It has a mode flag named <code class="docutils literal notranslate"><span class="pre">finished</span></code> to ignore everything after the <code class="docutils literal notranslate"><span class="pre">====</span></code> marker, and a scary-looking regular expression to match each line while hopefully ignoring other messages that might get displayed as the test runs.</p>
<p>Each time it identifies that a test has been completed, it increments its counter and delivers the new progress value to the step with <code class="docutils literal notranslate"><span class="pre">self.step.setProgress</span></code>.
This helps Buildbot to determine the ETA for the step.</p>
<p>To connect this parser into the <a class="reference internal" href="configuration/steps/trial.html#step-Trial" title="Trial"><code class="xref bb bb-step docutils literal notranslate"><span class="pre">Trial</span></code></a> build step, <code class="docutils literal notranslate"><span class="pre">Trial.__init__</span></code> ends with the following clause:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># this counter will feed Progress along the &#39;test cases&#39; metric</span>
<span class="n">counter</span> <span class="o">=</span> <span class="n">TrialTestCaseCounter</span><span class="p">()</span>
<span class="bp">self</span><span class="o">.</span><span class="n">addLogObserver</span><span class="p">(</span><span class="s1">&#39;stdio&#39;</span><span class="p">,</span> <span class="n">counter</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">progressMetrics</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;tests&#39;</span><span class="p">,)</span>
</pre></div>
</div>
<p>This creates a <code class="xref py py-class docutils literal notranslate"><span class="pre">TrialTestCaseCounter</span></code> and tells the step that the counter wants to watch the <code class="file docutils literal notranslate"><span class="pre">stdio</span></code> log.
The observer is automatically given a reference to the step in its <code class="xref py py-attr docutils literal notranslate"><span class="pre">step</span></code> attribute.</p>
</section>
<section id="using-properties">
<h3><a class="toc-backref" href="#id40" role="doc-backlink"><span class="section-number">2.6.12.9. </span>Using Properties</a><a class="headerlink" href="#using-properties" title="Link to this heading"></a></h3>
<p>In custom <code class="xref py py-class docutils literal notranslate"><span class="pre">BuildSteps</span></code>, you can get and set the build properties with the <code class="xref py py-meth docutils literal notranslate"><span class="pre">getProperty</span></code> and <code class="xref py py-meth docutils literal notranslate"><span class="pre">setProperty</span></code> methods.
Each takes a string for the name of the property, and returns or accepts an arbitrary JSON-able (lists, dicts, strings, and numbers) object.
For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MakeTarball</span><span class="p">(</span><span class="n">buildstep</span><span class="o">.</span><span class="n">ShellMixin</span><span class="p">,</span> <span class="n">buildstep</span><span class="o">.</span><span class="n">BuildStep</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setupShellMixin</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@defer</span><span class="o">.</span><span class="n">inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s2">&quot;os&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;win&quot;</span><span class="p">:</span>
            <span class="c1"># windows-only command</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">makeRemoteShellCommand</span><span class="p">(</span><span class="n">commad</span><span class="o">=</span><span class="p">[</span> <span class="o">...</span> <span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># equivalent for other systems</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">makeRemoteShellCommand</span><span class="p">(</span><span class="n">commad</span><span class="o">=</span><span class="p">[</span> <span class="o">...</span> <span class="p">])</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">runCommand</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cmd</span><span class="o">.</span><span class="n">results</span><span class="p">()</span>
</pre></div>
</div>
<p>Remember that properties set in a step may not be available until the next step begins.
In particular, any <code class="xref py py-class docutils literal notranslate"><span class="pre">Property</span></code> or <code class="xref py py-class docutils literal notranslate"><span class="pre">Interpolate</span></code> instances for the current step are interpolated before the step starts, so they cannot use the value of any properties determined in that step.</p>
</section>
<section id="using-statistics">
<span id="index-5"></span><h3><a class="toc-backref" href="#id41" role="doc-backlink"><span class="section-number">2.6.12.10. </span>Using Statistics</a><a class="headerlink" href="#using-statistics" title="Link to this heading"></a></h3>
<p>Statistics can be generated for each step, and then summarized across all steps in a build.
For example, a test step might set its <code class="docutils literal notranslate"><span class="pre">warnings</span></code> statistic to the number of warnings observed.
The build could then sum the <code class="docutils literal notranslate"><span class="pre">warnings</span></code> on all steps to get a total number of warnings.</p>
<p>Statistics are set and retrieved with the <a class="reference internal" href="../developer/cls-buildsteps.html#buildbot.process.buildstep.BuildStep.setStatistic" title="buildbot.process.buildstep.BuildStep.setStatistic"><code class="xref py py-meth docutils literal notranslate"><span class="pre">setStatistic</span></code></a> and <a class="reference internal" href="../developer/cls-buildsteps.html#buildbot.process.buildstep.BuildStep.getStatistic" title="buildbot.process.buildstep.BuildStep.getStatistic"><code class="xref py py-meth docutils literal notranslate"><span class="pre">getStatistic</span></code></a> methods.
The <a class="reference internal" href="../developer/cls-buildsteps.html#buildbot.process.buildstep.BuildStep.hasStatistic" title="buildbot.process.buildstep.BuildStep.hasStatistic"><code class="xref py py-meth docutils literal notranslate"><span class="pre">hasStatistic</span></code></a> method determines whether a statistic exists.</p>
<p>The Build method <a class="reference internal" href="../developer/cls-build.html#buildbot.process.build.Build.getSummaryStatistic" title="buildbot.process.build.Build.getSummaryStatistic"><code class="xref py py-meth docutils literal notranslate"><span class="pre">getSummaryStatistic</span></code></a> can be used to aggregate over all steps in a Build.</p>
</section>
<section id="buildstep-urls">
<h3><a class="toc-backref" href="#id42" role="doc-backlink"><span class="section-number">2.6.12.11. </span>BuildStep URLs</a><a class="headerlink" href="#buildstep-urls" title="Link to this heading"></a></h3>
<p>Each BuildStep has a collection of <cite>links</cite>.
Each has a name and a target URL.
The web display displays clickable links for each link, making them a useful way to point to extra information about a step.
For example, a step that uploads a build result to an external service might include a link to the uploaded file.</p>
<p>To set one of these links, the <code class="xref py py-class docutils literal notranslate"><span class="pre">BuildStep</span></code> should call the <a class="reference internal" href="../developer/cls-buildsteps.html#buildbot.process.buildstep.BuildStep.addURL" title="buildbot.process.buildstep.BuildStep.addURL"><code class="xref py py-meth docutils literal notranslate"><span class="pre">addURL</span></code></a> method with the name of the link and the target URL.
Multiple URLs can be set.
For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@defer</span><span class="o">.</span><span class="n">inlineCallbacks</span>
<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="o">...</span> <span class="c1"># create and upload report to coverage server</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://coverage.example.com/reports/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">reportname</span>
    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">addURL</span><span class="p">(</span><span class="s1">&#39;coverage&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
</pre></div>
</div>
<p>This also works from log observers, which is helpful for instance if the build output points to an external page such as a detailed log file. The following example parses output of <em>poudriere</em>, a tool for building packages on the FreeBSD operating system.</p>
<p>Example output:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[00:00:00] Creating the reference jail... done
...
[00:00:01] Logs: /usr/local/poudriere/data/logs/bulk/103amd64-2018Q4/2018-10-03_05h47m30s
...
... build log without details (those are in the above logs directory) ...
</pre></div>
</div>
<p>Log observer implementation:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">c</span> <span class="o">=</span> <span class="n">BuildmasterConfig</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">c</span><span class="p">[</span><span class="s1">&#39;titleURL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;https://my-buildbot.example.com/&#39;</span>
<span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">PoudriereLogLinkObserver</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">LogLineObserver</span><span class="p">):</span>
    <span class="n">_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="s1">&#39;Logs: /usr/local/poudriere/data/logs/bulk/([-_/0-9A-Za-z]+)$&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finished</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">outLineReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="c1"># Short-circuit if URL already found</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finished</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_regex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_finished</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># Let&#39;s assume local directory /usr/local/poudriere/data/logs/bulk</span>
            <span class="c1"># is available as https://my-buildbot.example.com/poudriere/logs</span>
            <span class="n">poudriere_ui_url</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;titleURL&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;poudriere/logs/&#39;</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># Add URLs for build overview page and for per-package log files</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">addURL</span><span class="p">(</span><span class="s1">&#39;Poudriere build web interface&#39;</span><span class="p">,</span> <span class="n">poudriere_ui_url</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">addURL</span><span class="p">(</span><span class="s1">&#39;Poudriere logs&#39;</span><span class="p">,</span> <span class="n">poudriere_ui_url</span> <span class="o">+</span> <span class="s1">&#39;/logs/&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="discovering-files">
<h3><a class="toc-backref" href="#id43" role="doc-backlink"><span class="section-number">2.6.12.12. </span>Discovering files</a><a class="headerlink" href="#discovering-files" title="Link to this heading"></a></h3>
<p>When implementing a <code class="xref py py-class docutils literal notranslate"><span class="pre">BuildStep</span></code> it may be necessary to know about files that are created during the build.
There are a few worker commands that can be used to find files on the worker and test for the existence (and type) of files and directories.</p>
<p>The worker provides the following file-discovery related commands:</p>
<ul class="simple">
<li><p><cite>stat</cite> calls <code class="xref py py-func docutils literal notranslate"><span class="pre">os.stat</span></code> for a file in the worker’s build directory.
This can be used to check if a known file exists and whether it is a regular file, directory or symbolic link.</p></li>
<li><p><cite>listdir</cite> calls <code class="xref py py-func docutils literal notranslate"><span class="pre">os.listdir</span></code> for a directory on the worker.
It can be used to obtain a list of files that are present in a directory on the worker.</p></li>
<li><p><cite>glob</cite> calls <code class="xref py py-func docutils literal notranslate"><span class="pre">glob.glob</span></code> on the worker, with a given shell-style pattern containing wildcards.</p></li>
</ul>
<p>For example, we could use stat to check if a given path exists and contains <code class="docutils literal notranslate"><span class="pre">*.pyc</span></code> files.
If the path does not exist (or anything fails) we mark the step as failed; if the path exists but is not a directory, we mark the step as having “warnings”.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">buildbot.plugins</span> <span class="kn">import</span> <span class="n">steps</span><span class="p">,</span> <span class="n">util</span>
<span class="kn">from</span> <span class="nn">buildbot.process</span> <span class="kn">import</span> <span class="n">remotecommand</span>
<span class="kn">from</span> <span class="nn">buildbot.interfaces</span> <span class="kn">import</span> <span class="n">WorkerSetupError</span>
<span class="kn">import</span> <span class="nn">stat</span>

<span class="k">class</span> <span class="nc">MyBuildStep</span><span class="p">(</span><span class="n">steps</span><span class="o">.</span><span class="n">BuildStep</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dirname</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dirname</span> <span class="o">=</span> <span class="n">dirname</span>

    <span class="nd">@defer</span><span class="o">.</span><span class="n">inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># make sure the worker knows about stat</span>
        <span class="n">workerver</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workerVersion</span><span class="p">(</span><span class="s1">&#39;stat&#39;</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">workerVersion</span><span class="p">(</span><span class="s1">&#39;glob&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">workerver</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">WorkerSetupError</span><span class="p">(</span><span class="s1">&#39;need stat and glob&#39;</span><span class="p">)</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="n">remotecommand</span><span class="o">.</span><span class="n">RemoteCommand</span><span class="p">(</span><span class="s1">&#39;stat&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirname</span><span class="p">})</span>

        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">runCommand</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cmd</span><span class="o">.</span><span class="n">didFail</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;File not found.&quot;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">FAILURE</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">updates</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">stat</span><span class="o">.</span><span class="n">ST_MODE</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&#39;tis not a directory&quot;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">WARNINGS</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="n">remotecommand</span><span class="o">.</span><span class="n">RemoteCommand</span><span class="p">(</span><span class="s1">&#39;glob&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirname</span> <span class="o">+</span> <span class="s1">&#39;/*.pyc&#39;</span><span class="p">})</span>

        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">runCommand</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cmd</span><span class="o">.</span><span class="n">didFail</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Glob failed.&quot;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">FAILURE</span>

        <span class="n">files</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">updates</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Found pycs&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">files</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;No pycs found&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">SUCCESS</span>
</pre></div>
</div>
<p>For more information on the available commands, see <a class="reference internal" href="../developer/master-worker.html"><span class="doc">Master-Worker API</span></a>.</p>
<div class="admonition-todo admonition" id="id12">
<p class="admonition-title">Todo</p>
<p>Step Progress
BuildStepFailed</p>
</div>
</section>
</section>
<section id="writing-dashboards-with-flask-or-bottle">
<span id="buildbot-wsgi-dashboards"></span><h2><span class="section-number">2.6.13. </span>Writing Dashboards with <a class="reference external" href="http://flask.pocoo.org/">Flask</a> or <a class="reference external" href="https://bottlepy.org/docs/dev/">Bottle</a><a class="headerlink" href="#writing-dashboards-with-flask-or-bottle" title="Link to this heading"></a></h2>
<p>Buildbot Nine UI is written in Javascript.
This allows it to be reactive and real time, but comes at a price of a fair complexity.</p>
<p>There is a Buildbot plugin which allows to write a server side generated dashboard, and integrate it in the UI.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># This needs buildbot and buildbot_www &gt;= 0.9.5</span>
<span class="n">pip</span> <span class="n">install</span> <span class="n">buildbot_wsgi_dashboards</span> <span class="n">flask</span>
</pre></div>
</div>
<ul>
<li><p>This plugin can use any WSGI compatible web framework, <a class="reference external" href="http://flask.pocoo.org/">Flask</a> is a very common one, <a class="reference external" href="https://bottlepy.org/docs/dev/">Bottle</a> is another popular option.</p></li>
<li><p>The application needs to implement a <code class="docutils literal notranslate"><span class="pre">/index.html</span></code> route, which will render the html code representing the dashboard.</p></li>
<li><p>The application framework runs in a thread outside of Twisted.
No need to worry about Twisted and asynchronous code.
You can use <a class="reference external" href="https://requests.readthedocs.io/en/master/">python-requests</a> or any library from the python ecosystem to access other servers.</p></li>
<li><p>You could use HTTP in order to access Buildbot <a class="reference internal" href="../developer/rest.html#rest-api"><span class="std std-ref">REST API</span></a>, but you can also use the <a class="reference internal" href="../developer/data.html#data-api"><span class="std std-ref">Data API</span></a>, via the provided synchronous wrapper.</p>
<blockquote>
<div><dl class="py method">
<dt class="sig sig-object py" id="buildbot_api.dataGet">
<span class="sig-prename descclassname"><span class="pre">buildbot_api.</span></span><span class="sig-name descname"><span class="pre">dataGet</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">filters</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">fields</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">order</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">limit</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">offset</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#buildbot_api.dataGet" title="Link to this definition"></a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>path</strong> (<em>tuple</em>) – A tuple of path elements representing the API path to fetch.
Numbers can be passed as strings or integers.</p></li>
<li><p><strong>filters</strong> – result spec filters</p></li>
<li><p><strong>fields</strong> – result spec fields</p></li>
<li><p><strong>order</strong> – result spec order</p></li>
<li><p><strong>limit</strong> – result spec limit</p></li>
<li><p><strong>offset</strong> – result spec offset</p></li>
</ul>
</dd>
<dt class="field-even">Raises<span class="colon">:</span></dt>
<dd class="field-even"><p><a class="reference internal" href="../developer/data.html#buildbot.data.exceptions.InvalidPathError" title="buildbot.data.exceptions.InvalidPathError"><code class="xref py py-exc docutils literal notranslate"><span class="pre">InvalidPathError</span></code></a></p>
</dd>
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p>a resource or list, or None</p>
</dd>
</dl>
<p>This is a blocking wrapper to master.data.get as described in <a class="reference internal" href="../developer/data.html#data-api"><span class="std std-ref">Data API</span></a>.
The available paths are described in the <a class="reference internal" href="../developer/rest.html#rest-api"><span class="std std-ref">REST API</span></a>, as well as the nature of return values depending on the kind of data that is fetched.
Path can be either the REST path e.g. <code class="docutils literal notranslate"><span class="pre">&quot;builders/2/builds/4&quot;</span></code> or tuple e.g. <code class="docutils literal notranslate"><span class="pre">(&quot;builders&quot;,</span> <span class="pre">2,</span> <span class="pre">&quot;builds&quot;,</span> <span class="pre">4)</span></code>.
The latter form being more convenient if some path parts are coming from variables.
The <a class="reference internal" href="../developer/data.html#data-api"><span class="std std-ref">Data API</span></a> and <a class="reference internal" href="../developer/rest.html#rest-api"><span class="std std-ref">REST API</span></a> are functionally equivalent except:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../developer/data.html#data-api"><span class="std std-ref">Data API</span></a> does not have HTTP connection overhead.</p></li>
<li><p><a class="reference internal" href="../developer/data.html#data-api"><span class="std std-ref">Data API</span></a> does not enforce authorization rules.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">buildbot_api.dataGet</span></code> is accessible via the WSGI application object passed to <code class="docutils literal notranslate"><span class="pre">wsgi_dashboards</span></code> plugin (as per the example).</p>
</dd></dl>

</div></blockquote>
</li>
<li><p>That html code output of the server runs inside AngularJS application.</p>
<ul class="simple">
<li><p>It will use the CSS of the AngularJS application (including the <a class="reference external" href="http://getbootstrap.com/css/">Bootstrap</a> CSS base).
You can use custom style-sheet with a standard <code class="docutils literal notranslate"><span class="pre">style</span></code> tag within your html.
Custom CSS will be shared with the whole Buildbot application once your dashboard is loaded.
So you should make sure your custom CSS rules only apply to your dashboard (e.g. by having a specific class for your dashboard’s main div)</p></li>
<li><p>It can use some of the AngularJS directives defined by Buildbot UI (currently only buildsummary is usable).</p></li>
<li><p>It has full access to the application JS context.</p></li>
</ul>
</li>
</ul>
</section>
<section id="a-somewhat-whimsical-example-or-it-s-now-customized-how-do-i-deploy-it">
<h2><a class="toc-backref" href="#id45" role="doc-backlink"><span class="section-number">2.6.14. </span>A Somewhat Whimsical Example (or “It’s now customized, how do I deploy it?”)</a><a class="headerlink" href="#a-somewhat-whimsical-example-or-it-s-now-customized-how-do-i-deploy-it" title="Link to this heading"></a></h2>
<p>Let’s say that we’ve got some snazzy new unit-test framework called Framboozle.
It’s the hottest thing since sliced bread.
It slices, it dices, it runs unit tests like there’s no tomorrow.
Plus if your unit tests fail, you can use its name for a Web 2.1 startup company, make millions of dollars, and hire engineers to fix the bugs for you, while you spend your afternoons lazily hang-gliding along a scenic pacific beach, blissfully unconcerned about the state of your tests.
<a class="footnote-reference brackets" href="#framboozle-reg" id="id13" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a></p>
<p>To run a Framboozle-enabled test suite, you just run the ‘framboozler’ command from the top of your source code tree.
The ‘framboozler’ command emits a bunch of stuff to stdout, but the most interesting bit is that it emits the line “FNURRRGH!” every time it finishes running a test case You’d like to have a test-case counting LogObserver that watches for these lines and counts them, because counting them will help the buildbot more accurately calculate how long the build will take, and this will let you know exactly how long you can sneak out of the office for your hang-gliding lessons without anyone noticing that you’re gone.</p>
<p>This will involve writing a new <code class="xref py py-class docutils literal notranslate"><span class="pre">BuildStep</span></code> (probably named “Framboozle”) which inherits from <a class="reference internal" href="configuration/steps/shell_command.html#step-ShellCommand" title="ShellCommand"><code class="xref bb bb-step docutils literal notranslate"><span class="pre">ShellCommand</span></code></a>.
The <code class="xref py py-class docutils literal notranslate"><span class="pre">BuildStep</span></code> class definition itself will look something like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">buildbot.plugins</span> <span class="kn">import</span> <span class="n">steps</span><span class="p">,</span> <span class="n">util</span>

<span class="k">class</span> <span class="nc">FNURRRGHCounter</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">LogLineObserver</span><span class="p">):</span>
    <span class="n">numTests</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">def</span> <span class="nf">outLineReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;FNURRRGH!&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">numTests</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">setProgress</span><span class="p">(</span><span class="s1">&#39;tests&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numTests</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Framboozle</span><span class="p">(</span><span class="n">steps</span><span class="o">.</span><span class="n">ShellCommand</span><span class="p">):</span>
    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;framboozler&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>   <span class="c1"># always upcall!</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="n">FNURRRGHCounter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addLogObserver</span><span class="p">(</span><span class="s1">&#39;stdio&#39;</span><span class="p">,</span> <span class="n">counter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progressMetrics</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;tests&#39;</span><span class="p">,)</span>
</pre></div>
</div>
<p>So that’s the code that we want to wind up using.
How do we actually deploy it?</p>
<p>You have a number of different options:</p>
<nav class="contents local" id="id14">
<ul class="simple">
<li><p><a class="reference internal" href="#inclusion-in-the-master-cfg-file" id="id52">Inclusion in the <code class="file docutils literal notranslate"><span class="pre">master.cfg</span></code> file</a></p></li>
<li><p><a class="reference internal" href="#python-file-somewhere-on-the-system" id="id53">Python file somewhere on the system</a></p></li>
<li><p><a class="reference internal" href="#install-this-code-into-a-standard-python-library-directory" id="id54">Install this code into a standard Python library directory</a></p></li>
<li><p><a class="reference internal" href="#distribute-a-buildbot-plug-in" id="id55">Distribute a Buildbot Plug-In</a></p></li>
<li><p><a class="reference internal" href="#submit-the-code-for-inclusion-in-the-buildbot-distribution" id="id56">Submit the code for inclusion in the Buildbot distribution</a></p></li>
<li><p><a class="reference internal" href="#summary" id="id57">Summary</a></p></li>
</ul>
</nav>
<section id="inclusion-in-the-master-cfg-file">
<h3><a class="toc-backref" href="#id52" role="doc-backlink"><span class="section-number">2.6.14.1. </span>Inclusion in the <code class="file docutils literal notranslate"><span class="pre">master.cfg</span></code> file</a><a class="headerlink" href="#inclusion-in-the-master-cfg-file" title="Link to this heading"></a></h3>
<p>The simplest technique is to simply put the step class definitions in your <code class="file docutils literal notranslate"><span class="pre">master.cfg</span></code> file, somewhere before the <code class="xref py py-class docutils literal notranslate"><span class="pre">BuildFactory</span></code> definition where you actually use it in a clause like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">BuildFactory</span><span class="p">()</span>
<span class="n">f</span><span class="o">.</span><span class="n">addStep</span><span class="p">(</span><span class="n">SVN</span><span class="p">(</span><span class="n">repourl</span><span class="o">=</span><span class="s2">&quot;stuff&quot;</span><span class="p">))</span>
<span class="n">f</span><span class="o">.</span><span class="n">addStep</span><span class="p">(</span><span class="n">Framboozle</span><span class="p">())</span>
</pre></div>
</div>
<p>Remember that <code class="file docutils literal notranslate"><span class="pre">master.cfg</span></code> is secretly just a Python program with one job: populating the <code class="xref py py-data docutils literal notranslate"><span class="pre">BuildmasterConfig</span></code> dictionary.
And Python programs are allowed to define as many classes as they like.
So you can define classes and use them in the same file, just as long as the class is defined before some other code tries to use it.</p>
<p>This is easy, and it keeps the point of definition very close to the point of use, and whoever replaces you after that unfortunate hang-gliding accident will appreciate being able to easily figure out what the heck this stupid “Framboozle” step is doing anyways.
The downside is that every time you reload the config file, the Framboozle class will get redefined, which means that the buildmaster will think that you’ve reconfigured all the Builders that use it, even though nothing changed.
Bleh.</p>
</section>
<section id="python-file-somewhere-on-the-system">
<h3><a class="toc-backref" href="#id53" role="doc-backlink"><span class="section-number">2.6.14.2. </span>Python file somewhere on the system</a><a class="headerlink" href="#python-file-somewhere-on-the-system" title="Link to this heading"></a></h3>
<p>Instead, we can put this code in a separate file, and import it into the master.cfg file just like we would the normal buildsteps like <a class="reference internal" href="configuration/steps/shell_command.html#step-ShellCommand" title="ShellCommand"><code class="xref bb bb-step docutils literal notranslate"><span class="pre">ShellCommand</span></code></a> and <a class="reference internal" href="configuration/steps/source_svn.html#step-SVN" title="SVN"><code class="xref bb bb-step docutils literal notranslate"><span class="pre">SVN</span></code></a>.</p>
<p>Create a directory named <code class="file docutils literal notranslate"><span class="pre">~/lib/python</span></code>, put the step class definitions in <code class="file docutils literal notranslate"><span class="pre">~/lib/python/framboozle.py</span></code>, and run your buildmaster using:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PYTHONPATH</span><span class="o">=</span>~/lib/python<span class="w"> </span>buildbot<span class="w"> </span>start<span class="w"> </span>MASTERDIR
</pre></div>
</div>
<p>or use the <code class="file docutils literal notranslate"><span class="pre">Makefile.buildbot</span></code> to control the way <code class="docutils literal notranslate"><span class="pre">buildbot</span> <span class="pre">start</span></code> works.
Or add something like this to something like your <code class="file docutils literal notranslate"><span class="pre">~/.bashrc</span></code> or <code class="file docutils literal notranslate"><span class="pre">~/.bash_profile</span></code> or <code class="file docutils literal notranslate"><span class="pre">~/.cshrc</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">PYTHONPATH</span><span class="o">=</span>~/lib/python
</pre></div>
</div>
<p>Once we’ve done this, our <code class="file docutils literal notranslate"><span class="pre">master.cfg</span></code> can look like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">framboozle</span> <span class="kn">import</span> <span class="n">Framboozle</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">BuildFactory</span><span class="p">()</span>
<span class="n">f</span><span class="o">.</span><span class="n">addStep</span><span class="p">(</span><span class="n">SVN</span><span class="p">(</span><span class="n">repourl</span><span class="o">=</span><span class="s2">&quot;stuff&quot;</span><span class="p">))</span>
<span class="n">f</span><span class="o">.</span><span class="n">addStep</span><span class="p">(</span><span class="n">Framboozle</span><span class="p">())</span>
</pre></div>
</div>
<p>or:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">framboozle</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">BuildFactory</span><span class="p">()</span>
<span class="n">f</span><span class="o">.</span><span class="n">addStep</span><span class="p">(</span><span class="n">SVN</span><span class="p">(</span><span class="n">repourl</span><span class="o">=</span><span class="s2">&quot;stuff&quot;</span><span class="p">))</span>
<span class="n">f</span><span class="o">.</span><span class="n">addStep</span><span class="p">(</span><span class="n">framboozle</span><span class="o">.</span><span class="n">Framboozle</span><span class="p">())</span>
</pre></div>
</div>
<p>(check out the Python docs for details about how <code class="docutils literal notranslate"><span class="pre">import</span></code> and <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">A</span> <span class="pre">import</span> <span class="pre">B</span></code> work).</p>
<p>What we’ve done here is to tell Python that every time it handles an “import” statement for some named module, it should look in our <code class="file docutils literal notranslate"><span class="pre">~/lib/python/</span></code> for that module before it looks anywhere else.
After our directories, it will try in a bunch of standard directories too (including the one where buildbot is installed).
By setting the <span class="target" id="index-6"></span><code class="xref std std-envvar docutils literal notranslate"><span class="pre">PYTHONPATH</span></code> environment variable, you can add directories to the front of this search list.</p>
<p>Python knows that once it “import”s a file, it doesn’t need to re-import it again.
This means that reconfiguring the buildmaster (with <code class="docutils literal notranslate"><span class="pre">buildbot</span> <span class="pre">reconfig</span></code>, for example) won’t make it think the Framboozle class has changed every time, so the Builders that use it will not be spuriously restarted.
On the other hand, you either have to start your buildmaster in a slightly weird way, or you have to modify your environment to set the <span class="target" id="index-7"></span><code class="xref std std-envvar docutils literal notranslate"><span class="pre">PYTHONPATH</span></code> variable.</p>
</section>
<section id="install-this-code-into-a-standard-python-library-directory">
<h3><a class="toc-backref" href="#id54" role="doc-backlink"><span class="section-number">2.6.14.3. </span>Install this code into a standard Python library directory</a><a class="headerlink" href="#install-this-code-into-a-standard-python-library-directory" title="Link to this heading"></a></h3>
<p>Find out what your Python’s standard include path is by asking it:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>80:warner@luther% python
Python 2.4.4c0 (#2, Oct  2 2006, 00:57:46)
[GCC 4.1.2 20060928 (prerelease) (Debian 4.1.1-15)] on linux2
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; import sys
&gt;&gt;&gt; import pprint
&gt;&gt;&gt; pprint.pprint(sys.path)
[&#39;&#39;,
 &#39;/usr/lib/python24.zip&#39;,
 &#39;/usr/lib/python2.4&#39;,
 &#39;/usr/lib/python2.4/plat-linux2&#39;,
 &#39;/usr/lib/python2.4/lib-tk&#39;,
 &#39;/usr/lib/python2.4/lib-dynload&#39;,
 &#39;/usr/local/lib/python2.4/site-packages&#39;,
 &#39;/usr/lib/python2.4/site-packages&#39;,
 &#39;/usr/lib/python2.4/site-packages/Numeric&#39;,
 &#39;/var/lib/python-support/python2.4&#39;,
 &#39;/usr/lib/site-python&#39;]
</pre></div>
</div>
<p>In this case, putting the code into <code class="file docutils literal notranslate"><span class="pre">/usr/local/lib/python2.4/site-packages/framboozle.py</span></code> would work just fine.
We can use the same <code class="file docutils literal notranslate"><span class="pre">master.cfg</span></code> <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">framboozle</span></code> statement as in Option 2.
By putting it in a standard include directory (instead of the decidedly non-standard <code class="file docutils literal notranslate"><span class="pre">~/lib/python</span></code>), we don’t even have to set <span class="target" id="index-8"></span><code class="xref std std-envvar docutils literal notranslate"><span class="pre">PYTHONPATH</span></code> to anything special.
The downside is that you probably have to be root to write to one of those standard include directories.</p>
</section>
<section id="distribute-a-buildbot-plug-in">
<span id="plugin-module"></span><h3><a class="toc-backref" href="#id55" role="doc-backlink"><span class="section-number">2.6.14.4. </span>Distribute a Buildbot Plug-In</a><a class="headerlink" href="#distribute-a-buildbot-plug-in" title="Link to this heading"></a></h3>
<p>First of all, you must prepare a Python package (if you do not know what that is, please check <a class="reference internal" href="../developer/plugins-publish.html"><span class="doc">How to package Buildbot plugins</span></a>, where you can find a couple of pointers to tutorials).</p>
<p>When you have a package, you will have a special file called <code class="file docutils literal notranslate"><span class="pre">setup.py</span></code>.
This file needs to be updated to include a pointer to your new step:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">setup</span><span class="p">(</span>
    <span class="o">...</span>
    <span class="n">entry_points</span> <span class="o">=</span> <span class="p">{</span>
        <span class="o">...</span><span class="p">,</span>
        <span class="s1">&#39;buildbot.steps&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">&#39;Framboozle = framboozle:Framboozle&#39;</span>
        <span class="p">]</span>
    <span class="p">},</span>
    <span class="o">...</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Where:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">buildbot.steps</span></code> is the kind of plugin you offer (more information about possible kinds you can find in <a class="reference internal" href="../developer/plugins-publish.html"><span class="doc">How to package Buildbot plugins</span></a>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">framboozle:Framboozle</span></code> consists of two parts: <code class="docutils literal notranslate"><span class="pre">framboozle</span></code> is the name of the Python module where to look for <code class="docutils literal notranslate"><span class="pre">Framboozle</span></code> class, which implements the plugin</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Framboozle</span></code> is the name of the plugin.</p>
<p>This will allow users of your plugin to use it just like any other Buildbot plugins:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">buildbot.plugins</span> <span class="kn">import</span> <span class="n">steps</span>

<span class="o">...</span> <span class="n">steps</span><span class="o">.</span><span class="n">Framboozle</span> <span class="o">...</span>
</pre></div>
</div>
</li>
</ul>
<p>Now you can upload it to <a class="reference external" href="http://pypi.python.org/">PyPI</a> where other people can download it from and use in their build systems.
Once again, the information about how to prepare and upload a package to <a class="reference external" href="http://pypi.python.org/">PyPI</a> can be found in tutorials listed in <a class="reference internal" href="../developer/plugins-publish.html"><span class="doc">How to package Buildbot plugins</span></a>.</p>
</section>
<section id="submit-the-code-for-inclusion-in-the-buildbot-distribution">
<h3><a class="toc-backref" href="#id56" role="doc-backlink"><span class="section-number">2.6.14.5. </span>Submit the code for inclusion in the Buildbot distribution</a><a class="headerlink" href="#submit-the-code-for-inclusion-in-the-buildbot-distribution" title="Link to this heading"></a></h3>
<p>Make a fork of buildbot on <a class="reference external" href="http://github.com/buildbot/buildbot">http://github.com/buildbot/buildbot</a> or post a patch in a bug at <a class="reference external" href="http://trac.buildbot.net/">http://trac.buildbot.net/</a>.
In either case, post a note about your patch to the mailing list, so others can provide feedback and, eventually, commit it.</p>
<p>When it’s committed to the master, the usage is the same as in the previous approach:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">buildbot.plugins</span> <span class="kn">import</span> <span class="n">steps</span><span class="p">,</span> <span class="n">util</span>

<span class="o">...</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">BuildFactory</span><span class="p">()</span>
<span class="n">f</span><span class="o">.</span><span class="n">addStep</span><span class="p">(</span><span class="n">steps</span><span class="o">.</span><span class="n">SVN</span><span class="p">(</span><span class="n">repourl</span><span class="o">=</span><span class="s2">&quot;stuff&quot;</span><span class="p">))</span>
<span class="n">f</span><span class="o">.</span><span class="n">addStep</span><span class="p">(</span><span class="n">steps</span><span class="o">.</span><span class="n">Framboozle</span><span class="p">())</span>
<span class="o">...</span>
</pre></div>
</div>
<p>And then you don’t even have to install <code class="file docutils literal notranslate"><span class="pre">framboozle.py</span></code> anywhere on your system, since it will ship with Buildbot.
You don’t have to be root, you don’t have to set <span class="target" id="index-9"></span><code class="xref std std-envvar docutils literal notranslate"><span class="pre">PYTHONPATH</span></code>.
But you do have to make a good case for Framboozle being worth going into the main distribution, you’ll probably have to provide docs and some unit test cases, you’ll need to figure out what kind of beer the author likes (IPA’s and Stouts for Dustin), and then you’ll have to wait until the next release.
But in some environments, all this is easier than getting root on your buildmaster box, so the tradeoffs may actually be worth it.</p>
</section>
<section id="summary">
<h3><a class="toc-backref" href="#id57" role="doc-backlink"><span class="section-number">2.6.14.6. </span>Summary</a><a class="headerlink" href="#summary" title="Link to this heading"></a></h3>
<p>Putting the code in master.cfg (1) makes it available to that buildmaster instance.
Putting it in a file in a personal library directory (2) makes it available for any buildmasters you might be running.
Putting it in a file in a system-wide shared library directory (3) makes it available for any buildmasters that anyone on that system might be running.
Getting it into the buildbot’s upstream repository (4) makes it available for any buildmasters that anyone in the world might be running.
It’s all a matter of how widely you want to deploy that new class.</p>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="framboozle-reg" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id13">1</a><span class="fn-bracket">]</span></span>
<p>framboozle.com is still available.
Remember, I get 10% :).</p>
</aside>
</aside>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="configuration/tests/steps.html" class="btn btn-neutral float-left" title="2.5.25.3. TestBuildStepMixin" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="cmdline.html" class="btn btn-neutral float-right" title="2.7. Command-line Tool" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Buildbot Team Members.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>