<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3.3.19. Secrets &mdash; Buildbot 4.0.2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=d10597a4" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/buildbot_rtd.css?v=915d5e18" />

  
    <link rel="shortcut icon" href="../_static/icon.png"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=a084f797"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="3.3.22. Statistics Service" href="stats-service.html" />
    <link rel="prev" title="3.3.18. Metrics" href="metrics.html" /> 
<!-- GA-TRACKING-START -->
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try{
var pageTracker = _gat._getTracker("UA-12313843-4");
pageTracker._setDomainName("none");
pageTracker._setAllowLinker(true);
pageTracker._trackPageview();
} catch(err) {}
</script>
<!-- GA-TRACKING-END -->
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Buildbot
              <img src="../_static/full_logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                4.0.2
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../tutorial/index.html">1. Buildbot Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../manual/index.html">2. Buildbot Manual</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">3. Buildbot Development</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="quickstart.html">3.1. Development Quick-start</a></li>
<li class="toctree-l2"><a class="reference internal" href="pull-request.html">3.2. Submitting Pull Requests</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="general.html">3.3. General Documents</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="master-overview.html">3.3.1. Master Organization</a></li>
<li class="toctree-l3"><a class="reference internal" href="style.html">3.3.2. Buildbot Coding Style</a></li>
<li class="toctree-l3"><a class="reference internal" href="tests.html">3.3.3. Buildbot’s Test Suite</a></li>
<li class="toctree-l3"><a class="reference internal" href="config.html">3.3.4. Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="config.html#configuration-in-angularjs">3.3.5. Configuration in AngularJS</a></li>
<li class="toctree-l3"><a class="reference internal" href="schedulers.html">3.3.6. Writing Schedulers</a></li>
<li class="toctree-l3"><a class="reference internal" href="utils.html">3.3.7. Utilities</a></li>
<li class="toctree-l3"><a class="reference internal" href="results.html">3.3.8. Build Result Codes</a></li>
<li class="toctree-l3"><a class="reference internal" href="www-server.html">3.3.9. WWW Server</a></li>
<li class="toctree-l3"><a class="reference internal" href="www-data-module.html">3.3.10. Javascript Data Module</a></li>
<li class="toctree-l3"><a class="reference internal" href="www-base-app.html">3.3.11. Base web application</a></li>
<li class="toctree-l3"><a class="reference internal" href="auth.html">3.3.12. Authentication</a></li>
<li class="toctree-l3"><a class="reference internal" href="authz.html">3.3.13. Authorization</a></li>
<li class="toctree-l3"><a class="reference internal" href="master-worker.html">3.3.14. Master-Worker API</a></li>
<li class="toctree-l3"><a class="reference internal" href="master-worker-msgpack.html">3.3.15. Master-Worker connection with MessagePack over WebSocket protocol</a></li>
<li class="toctree-l3"><a class="reference internal" href="br-claiming.html">3.3.16. Claiming Build Requests</a></li>
<li class="toctree-l3"><a class="reference internal" href="encodings.html">3.3.17. String Encodings</a></li>
<li class="toctree-l3"><a class="reference internal" href="metrics.html">3.3.18. Metrics</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">3.3.19. Secrets</a></li>
<li class="toctree-l3"><a class="reference internal" href="#secrets-manager">3.3.20. Secrets manager</a></li>
<li class="toctree-l3"><a class="reference internal" href="#secrets-providers">3.3.21. Secrets providers</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#file-provider">3.3.21.1. File provider</a></li>
<li class="toctree-l4"><a class="reference internal" href="#vault-provider">3.3.21.2. Vault provider</a></li>
<li class="toctree-l4"><a class="reference internal" href="#interpolate-secret">3.3.21.3. Interpolate secret</a></li>
<li class="toctree-l4"><a class="reference internal" href="#secret-obfuscation">3.3.21.4. Secret Obfuscation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#how-to-use-a-secret-in-a-buildbotservice">3.3.21.5. How to use a secret in a BuildbotService</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="stats-service.html">3.3.22. Statistics Service</a></li>
<li class="toctree-l3"><a class="reference internal" href="plugins-publish.html">3.3.23. How to package Buildbot plugins</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="rest.html">3.4. REST API</a></li>
<li class="toctree-l2"><a class="reference internal" href="raml/index.html">3.5. REST API Specification</a></li>
<li class="toctree-l2"><a class="reference internal" href="data.html">3.6. Data API</a></li>
<li class="toctree-l2"><a class="reference internal" href="database.html">3.7. Database</a></li>
<li class="toctree-l2"><a class="reference internal" href="database/index.html">3.8. Database connectors API</a></li>
<li class="toctree-l2"><a class="reference internal" href="mq.html">3.9. Messaging and Queues</a></li>
<li class="toctree-l2"><a class="reference internal" href="classes.html">3.10. Classes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../relnotes/index.html">4. Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../relnotes/index.html#older-release-notes">5. Older Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../indices.html">6. API Indices</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Buildbot</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html"><span class="section-number">3. </span>Buildbot Development</a></li>
          <li class="breadcrumb-item"><a href="general.html"><span class="section-number">3.3. </span>General Documents</a></li>
      <li class="breadcrumb-item active"><span class="section-number">3.3.19. </span>Secrets</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/developer/secrets.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="secrets">
<h1><span class="section-number">3.3.19. </span>Secrets<a class="headerlink" href="#secrets" title="Link to this heading"></a></h1>
<p>A Secret is defined by a key associated with a value, returned from a provider.
Secrets returned by providers are stored in a <code class="docutils literal notranslate"><span class="pre">SecretDetails</span></code> object.
A <code class="docutils literal notranslate"><span class="pre">SecretDetails</span></code> object is initialized with a provider name, a key and a value.
Each parameter is an object property.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">secret</span> <span class="o">=</span> <span class="n">SecretDetails</span><span class="p">(</span><span class="s2">&quot;SourceProvider&quot;</span><span class="p">,</span> <span class="s2">&quot;myKey&quot;</span><span class="p">,</span> <span class="s2">&quot;myValue&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">secret</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
<span class="s2">&quot;SourceProvider&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">secret</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
<span class="s2">&quot;myKey&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">secret</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="s2">&quot;myValue&quot;</span>
</pre></div>
</div>
</section>
<section id="secrets-manager">
<h1><span class="section-number">3.3.20. </span>Secrets manager<a class="headerlink" href="#secrets-manager" title="Link to this heading"></a></h1>
<p>The secrets manager is a Buildbot service manager.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">secretsService</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">namedServices</span><span class="p">[</span><span class="s1">&#39;secrets&#39;</span><span class="p">]</span>
<span class="n">secretDetailsList</span> <span class="o">=</span> <span class="n">secretsService</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">secrets</span><span class="p">)</span>
</pre></div>
</div>
<p>The service executes a get method.
Depending on the kind of storage chosen and declared in the configuration, the manager gets the selected provider and returns a list of <code class="docutils literal notranslate"><span class="pre">secretDetails</span></code>.</p>
</section>
<section id="secrets-providers">
<h1><span class="section-number">3.3.21. </span>Secrets providers<a class="headerlink" href="#secrets-providers" title="Link to this heading"></a></h1>
<p>The secrets providers are implementing the specific getters, related to the storage chosen.</p>
<section id="file-provider">
<h2><span class="section-number">3.3.21.1. </span>File provider<a class="headerlink" href="#file-provider" title="Link to this heading"></a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;secretsProviders&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">secrets</span><span class="o">.</span><span class="n">SecretInAFile</span><span class="p">(</span><span class="n">dirname</span><span class="o">=</span><span class="s2">&quot;/path/toSecretsFiles&quot;</span><span class="p">)]</span>
</pre></div>
</div>
<p>In the master configuration the provider is instantiated through a Buildbot service secret manager with the file directory path.
File secrets provider reads the file named by the key wanted by Buildbot and returns the contained text value (removing trailing newlines if present).
SecretInAFile provider allows Buildbot to read secrets in the secret directory.</p>
</section>
<section id="vault-provider">
<h2><span class="section-number">3.3.21.2. </span>Vault provider<a class="headerlink" href="#vault-provider" title="Link to this heading"></a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;secretsProviders&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">secrets</span><span class="o">.</span><span class="n">HashiCorpVaultKvSecretProvider</span><span class="p">(</span><span class="n">authenticator</span><span class="o">=</span><span class="n">secrets</span><span class="o">.</span><span class="n">VaultAuthenticatorApprole</span><span class="p">(</span><span class="n">roleId</span><span class="o">=</span><span class="s2">&quot;xxx&quot;</span><span class="p">,</span> <span class="n">secretId</span><span class="o">=</span><span class="s2">&quot;yyy&quot;</span><span class="p">),</span>
                                                                <span class="n">vault_server</span><span class="o">=</span><span class="s2">&quot;http://localhost:8200&quot;</span><span class="p">)]</span>
</pre></div>
</div>
<p>In the master configuration, the provider is instantiated through a Buildbot service secret manager with the Vault authenticator and the Vault server address.
Vault secrets provider accesses the Vault backend asking the key wanted by Buildbot and returns the contained text value.
SecretInVaultKv provider allows Buildbot to read secrets only in the Vault KV store, other secret engines are not supported by this provider.
Currently v1 and v2 of the Key-Value secret engines are supported, v2 being the default version.</p>
</section>
<section id="interpolate-secret">
<h2><span class="section-number">3.3.21.3. </span>Interpolate secret<a class="headerlink" href="#interpolate-secret" title="Link to this heading"></a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">text</span> <span class="o">=</span> <span class="n">Interpolate</span><span class="p">(</span><span class="s2">&quot;some text and %(secret:foo)s&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Secret keys are replaced in a string by the secret value using the class Interpolate and the keyword secret.
The secret is searched across the providers defined in the master configuration.</p>
</section>
<section id="secret-obfuscation">
<h2><span class="section-number">3.3.21.4. </span>Secret Obfuscation<a class="headerlink" href="#secret-obfuscation" title="Link to this heading"></a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">text</span> <span class="o">=</span> <span class="n">Interpolate</span><span class="p">(</span><span class="s2">&quot;some text and %(secret:foo)s&quot;</span><span class="p">)</span>
<span class="c1"># some text rendered</span>
<span class="n">rendered</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="n">cleantext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">cleanupTextFromSecrets</span><span class="p">(</span><span class="n">rendered</span><span class="p">)</span>
</pre></div>
</div>
<p>Secrets don’t have to be visible to the normal user via logs and thus are transmitted directly to the workers.
Secrets are rendered and can arrive anywhere in the logs.
The function <code class="docutils literal notranslate"><span class="pre">cleanupTextFromSecrets</span></code> defined in the class Properties helps to replace the secret value by the key value.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;the example value is:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cleantext</span><span class="p">))</span>
<span class="o">&gt;&gt;</span> <span class="n">the</span> <span class="n">example</span> <span class="n">value</span> <span class="ow">is</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">foo</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The secret is rendered and is recorded in a dictionary, named <code class="docutils literal notranslate"><span class="pre">_used_secrets</span></code>, where the key is the secret value and the value the secret key.
Therefore anywhere logs are written having content with secrets, the secrets are replaced by the value from <code class="docutils literal notranslate"><span class="pre">_used_secrets</span></code>.</p>
</section>
<section id="how-to-use-a-secret-in-a-buildbotservice">
<h2><span class="section-number">3.3.21.5. </span>How to use a secret in a BuildbotService<a class="headerlink" href="#how-to-use-a-secret-in-a-buildbotservice" title="Link to this heading"></a></h2>
<p>Service configurations are loaded during a Buildbot start or modified during a Buildbot restart.
Secrets are used like renderables in a service and are rendered during the configuration load.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyService</span><span class="p">(</span><span class="n">BuildbotService</span><span class="p">):</span>
  <span class="n">secrets</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;other&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">secrets</span></code> is a list containing all the secret keys that can be used as class attributes.
When the service is loaded during the Buildbot reconfigService function, secrets are rendered and the values are updated.
Everywhere the variable with the secret name (<cite>foo</cite> or <cite>other</cite> in the example) is used, the class attribute value is replaced by the secret value.
This is similar to the “renderable” annotation, but will only work for BuildbotServices, and will only interpolate secrets.
Other renderables can still be held in the service as attributes and rendered dynamically at a later time.</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyService</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="n">secrets</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;other&#39;</span><span class="p">]</span>

<span class="n">myService</span> <span class="o">=</span> <span class="n">MyService</span><span class="p">()</span>
</pre></div>
</div>
</div></blockquote>
<p>After a Buildbot reconfigService:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;myService returns secret value:&quot;</span><span class="p">,</span> <span class="n">myService</span><span class="o">.</span><span class="n">foo</span><span class="p">))</span>
<span class="o">&gt;&gt;</span> <span class="n">myService</span> <span class="n">returns</span> <span class="n">secret</span> <span class="n">value</span> <span class="n">bar</span>
</pre></div>
</div>
</div></blockquote>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="metrics.html" class="btn btn-neutral float-left" title="3.3.18. Metrics" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="stats-service.html" class="btn btn-neutral float-right" title="3.3.22. Statistics Service" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Buildbot Team Members.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>